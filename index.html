<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading P/L Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=DM+Sans:wght@400;700&family=Exo+2:wght@400;700&family=Fira+Code:wght@400;700&family=IBM+Plex+Mono:wght@400;700&family=Inter:wght@400;700&family=Lato:wght@400;700&family=JetBrains+Mono:wght@400;700&family=Merriweather:wght@400;700&family=Montserrat:wght@400;700&family=Nunito:wght@400;700&family=Orbitron:wght@400;700&family=Oxanium:wght@400;700&family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@400;700&family=Russo+One&family=Source+Sans+Pro:wght@400;700&family=Space+Mono:wght@400;700&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        /* --- Base Styles --- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        body {
            font-family: 'Lato', 'Poppins', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }
        .app-body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .main-container {
            width: 100%;
            max-width: 420px;
            margin: auto;
            display: flex;
            flex-direction: column;
            border-radius: 1.5rem;
            overflow: hidden;
            height: 95vh;
            max-height: 900px;
            transition: background-color 0.3s ease, border 0.3s ease, box-shadow 0.4s ease;
            position: relative; /* Needed for animation pseudo-element */
        }
        .calc-btn {
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            border-radius: 1.25rem;
            box-shadow: 0 4px 15px -1px rgba(0,0,0,0.1);
            transition: all 0.15s ease-in-out;
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden; /* To contain the ripple */
        }
        .calc-btn:active {
            transform: scale(0.96);
            box-shadow: 0 2px 5px -1px rgba(0,0,0,0.1);
        }
        .btn { @apply font-bold rounded-lg shadow-md transition-transform transform hover:scale-105 active:scale-95; }
        
        #buttons-container {
            position: relative; 
        }

        /* --- View Switcher Styles --- */
        .view {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 1.5rem;
            animation: fadeIn 0.3s ease-in-out;
            overflow-y: auto;
        }
        .view.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .icon-btn { @apply p-1 transition-colors duration-200; }
        .stats-label { @apply text-sm font-medium; }
        .stats-value { @apply text-lg font-semibold; }
        .form-input { @apply w-full rounded-md p-2 mt-1; }

        /* --- Data Ring Styles --- */
        .data-ring-container {
            position: relative;
            width: 80px;
            height: 80px;
            cursor: pointer;
        }
        .data-ring-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
            transition: opacity 0.2s ease-in-out;
        }
        .data-ring-circle {
            transition: stroke-dashoffset 0.5s ease-out;
        }
        .data-ring-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            pointer-events: none;
        }
        .data-ring-text .value { font-size: 1.75rem; font-weight: 700; line-height: 1; }
        .data-ring-details { display: none; }

        .data-ring-container.show-details .data-ring-total { display: none; }
        .data-ring-container.show-details .data-ring-details { display: flex; }
        .data-ring-container.show-details .data-ring-svg { opacity: 0.2; }
        .data-ring-details .profit-value { font-size: 1.1rem; font-weight: 700; line-height: 1.2; }
        .data-ring-details .wl-value { font-size: 0.8rem; font-weight: 500; }

        /* --- New Theme Selector Styles --- */
        .theme-card {
            position: relative;
            cursor: pointer;
            border-radius: 1rem; /* 16px */
            padding: 1rem; /* 16px */
            transition: all 0.2s ease-in-out;
            border: 2px solid;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* 12px */
        }
        .theme-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px -4px rgba(0,0,0,0.1);
        }
        .theme-card.selected {
            border-color: var(--selected-theme-border-color, #3b82f6); /* Default blue, will be overridden by JS */
            box-shadow: 0 0 0 3px var(--selected-theme-shadow-color, rgba(59, 130, 246, 0.4));
        }
        .theme-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .theme-name-new {
            font-weight: 600;
            font-size: 1rem; /* 16px */
        }
        .theme-swatches {
            display: flex;
            gap: 0.5rem; /* 8px */
            margin-top: auto; /* Pushes to the bottom */
        }
        .swatch {
            width: 1.5rem; /* 24px */
            height: 1.5rem; /* 24px */
            border-radius: 9999px;
            border: 2px solid rgba(128, 128, 128, 0.3);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .checkmark-icon {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 1.5rem; /* 24px */
            height: 1.5rem; /* 24px */
            background-color: var(--selected-theme-border-color, #3b82f6);
            color: white;
            border-radius: 9999px;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }
        .theme-card.selected .checkmark-icon {
            display: flex; /* Show when selected */
        }

        /* --- Animation Styles --- */
        /* Radiating Flash Animation */
        @keyframes radiate-flash {
            from { transform: translate(-50%, -50%) scale(0); opacity: 0.6; }
            to { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }
        .main-container.flash-anim::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 100%; height: 100%;
            border-radius: 50%;
            background: var(--anim-color, transparent);
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            pointer-events: none;
            animation: radiate-flash 0.7s ease-out forwards;
        }

        /* Border Pulse Animation */
        @keyframes border-pulse {
            0% { box-shadow: 0 0 0 0 var(--anim-color-transparent); }
            50% { box-shadow: 0 0 20px 5px var(--anim-color); }
            100% { box-shadow: 0 0 0 0 var(--anim-color-transparent); }
        }
        .main-container.border-pulse-anim {
            animation: border-pulse 0.8s ease-in-out;
        }

        /* Ripple Animation */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            background-color: var(--anim-color);
            pointer-events: none;
        }
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Score Pulse Animation */
        @keyframes score-pulse {
            50% {
                transform: scale(1.1);
                text-shadow: 0 0 25px var(--anim-color, #fff);
            }
        }
        .score-pulse-anim {
            animation: score-pulse 0.5s ease-out;
        }

        /* --- Dark Theme (Default) --- */
        .dark-theme { background: linear-gradient(to top, #000000, #111111); color: #F9FAFB; font-family: 'Poppins', sans-serif; }
        .dark-theme .main-container { background-color: rgba(17, 17, 17, 0.5); border: none; }
        .dark-theme .header-text, .dark-theme .score-text { color: #fff; }
        .dark-theme .sub-text { color: #a0aec0; }
        .dark-theme .btn-positive { background-color: #15803d; color: white; }
        .dark-theme .btn-positive:hover { background-color: #16a34a; }
        .dark-theme .btn-negative { background-color: #b91c1c; color: white; }
        .dark-theme .btn-negative:hover { background-color: #dc2626; }
        .dark-theme .btn-neutral { background-color: #374151; color: white; }
        .dark-theme .btn-neutral:hover { background-color: #4b5563; }
        .dark-theme .btn-secondary, .dark-theme .btn-action, .dark-theme .dropdown, .dark-theme .history-item { background-color: #1a202c; border-color: #2d3748; color: #e2e8f0; }
        .dark-theme .btn-action { background-color: #2b6cb0; }
        .dark-theme .btn-action:hover { background-color: #3182ce; }
        .dark-theme .stats-value.positive, .dark-theme .profit-positive { color: #48bb78; }
        .dark-theme .stats-value.negative, .dark-theme .profit-negative { color: #f56565; }
        .dark-theme .icon-btn { color: #a0aec0; }
        .dark-theme .icon-btn:hover { color: #fff; }
        .dark-theme .score-glow-positive { text-shadow: 0 0 15px rgba(72, 187, 120, 0.5); }
        .dark-theme .score-glow-negative { text-shadow: 0 0 15px rgba(245, 101, 101, 0.5); }
        .dark-theme .form-input { background-color: #2d3748; border: 1px solid #4a5568; color: #F9FAFB; }
        .dark-theme .form-input::placeholder { color: #718096; }
        .dark-theme .ring-track { stroke: #2d3748; }
        .dark-theme .ring-wins { stroke: #48bb78; }
        .dark-theme .ring-losses { stroke: #f56565; }
        .dark-theme .data-ring-text { color: #e2e8f0; }
        .dark-theme .stats-card { background-color: #2d3748; }

        /* --- Ice Theme --- */
        .ice-theme { background: linear-gradient(to top, #f3e5f5, #e0f7fa); color: #2d3748; font-family: 'Lato', sans-serif; }
        .ice-theme .main-container { background-color: rgba(255, 255, 255, 0.5); border: none; }
        .ice-theme .header-text, .ice-theme .score-text { color: #1a202c; }
        .ice-theme .sub-text { color: #718096; }
        .ice-theme .btn-positive { background-color: transparent; color: #3182ce; border-color: #3182ce; }
        .ice-theme .btn-positive:hover { background-color: #3182ce; color: white; }
        .ice-theme .btn-negative { background-color: transparent; color: #805ad5; border-color: #805ad5; }
        .ice-theme .btn-negative:hover { background-color: #805ad5; color: white; }
        .ice-theme .btn-neutral { background-color: #e2e8f0; color: #2d3748; }
        .ice-theme .btn-neutral:hover { background-color: #cbd5e0; }
        .ice-theme .btn-secondary, .ice-theme .btn-action, .ice-theme .dropdown, .ice-theme .history-item { background-color: #fff; border-color: #e2e8f0; color: #2d3748; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); }
        .ice-theme .btn-action { background-color: #805ad5; color: white; }
        .ice-theme .btn-action:hover { background-color: #9f7aea; }
        .ice-theme .stats-value.positive, .ice-theme .profit-positive { color: #3182ce; }
        .ice-theme .stats-value.negative, .ice-theme .profit-negative { color: #805ad5; }
        .ice-theme .icon-btn { color: #718096; }
        .ice-theme .icon-btn:hover { color: #1a202c; }
        .ice-theme .score-glow-positive { text-shadow: 0 0 15px rgba(56, 161, 105, 0.4); }
        .ice-theme .score-glow-negative { text-shadow: 0 0 15px rgba(197, 48, 48, 0.4); }
        .ice-theme .form-input { background-color: #fff; border: 1px solid #cbd5e0; color: #2d3748; }
        .ice-theme .form-input::placeholder { color: #a0aec0; }
        .ice-theme .ring-track { stroke: #e2e8f0; }
        .ice-theme .ring-wins { stroke: #4299e1; }
        .ice-theme .ring-losses { stroke: #9f7aea; }
        .ice-theme .data-ring-text { color: #2d3748; }
        .ice-theme .stats-card { background-color: #fff; }

        /* --- Sunrise Theme --- */
        .sunrise-theme { background: linear-gradient(to top, #D8B4FE, #FDE68A); color: #422006; font-family: 'Lato', sans-serif; }
        .sunrise-theme .main-container { background-color: rgba(255, 255, 255, 0.65); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .sunrise-theme .header-text, .sunrise-theme .score-text { color: #422006; }
        .sunrise-theme .sub-text { color: #78350F; }
        .sunrise-theme .btn-positive { background-color: #F97316; color: white; }
        .sunrise-theme .btn-positive:hover { background-color: #EA580C; }
        .sunrise-theme .btn-negative { background-color: #581C87; color: white; }
        .sunrise-theme .btn-negative:hover { background-color: #4C1D95; }
        .sunrise-theme .btn-neutral { background-color: #854D0E; color: white; }
        .sunrise-theme .btn-neutral:hover { background-color: #78350F; }
        .sunrise-theme .btn-secondary, .sunrise-theme .btn-action, .sunrise-theme .dropdown, .sunrise-theme .history-item { background-color: rgba(255, 255, 255, 0.4); border-color: rgba(133, 77, 14, 0.2); color: #422006; }
        .sunrise-theme .btn-action { background-color: #854D0E; color: white; }
        .sunrise-theme .btn-action:hover { background-color: #78350F; }
        .sunrise-theme .stats-value.positive, .sunrise-theme .profit-positive { color: #F97316; }
        .sunrise-theme .stats-value.negative, .sunrise-theme .profit-negative { color: #581C87; }
        .sunrise-theme .icon-btn { color: #78350F; }
        .sunrise-theme .icon-btn:hover { color: #422006; }
        .sunrise-theme .score-glow-positive { text-shadow: 0 0 15px rgba(249, 115, 22, 0.5); }
        .sunrise-theme .score-glow-negative { text-shadow: 0 0 15px rgba(88, 28, 135, 0.5); }
        .sunrise-theme .form-input { background-color: rgba(255, 255, 255, 0.5); border: 1px solid rgba(133, 77, 14, 0.3); color: #422006; }
        .sunrise-theme .form-input::placeholder { color: #854D0E; }
        .sunrise-theme .ring-track { stroke: rgba(133, 77, 14, 0.2); }
        .sunrise-theme .ring-wins { stroke: #F97316; }
        .sunrise-theme .ring-losses { stroke: #581C87; }
        .sunrise-theme .data-ring-text { color: #422006; }
        .sunrise-theme .stats-card { background-color: rgba(255, 255, 255, 0.5); }

        /* --- Cyberpunk Theme --- */
        .cyberpunk-theme { background: linear-gradient(to top, #2D0B5A, #0C1445); color: #A5F3FC; font-family: 'Orbitron', sans-serif; }
        .cyberpunk-theme .main-container { background-color: rgba(10, 10, 25, 0.5); backdrop-filter: blur(12px); border: 2px solid #F472B6; box-shadow: 0 0 15px rgba(244, 114, 182, 0.5); }
        .cyberpunk-theme .header-text, .cyberpunk-theme .score-text { color: #22D3EE; }
        .cyberpunk-theme .sub-text { color: #A5F3FC; }
        .cyberpunk-theme .btn-positive { background-color: #22D3EE; color: #0C1445; border-color: #22D3EE; }
        .cyberpunk-theme .btn-positive:hover { background-color: #A5F3FC; }
        .cyberpunk-theme .btn-negative { background-color: #F472B6; color: white; border-color: #F472B6; }
        .cyberpunk-theme .btn-negative:hover { background-color: #EC4899; }
        .cyberpunk-theme .btn-neutral { background-color: #A3E635; color: #0C1445; border-color: #A3E635; }
        .cyberpunk-theme .btn-neutral:hover { background-color: #BEF264; }
        .cyberpunk-theme .btn-secondary, .cyberpunk-theme .btn-action, .cyberpunk-theme .dropdown, .cyberpunk-theme .history-item { background-color: rgba(10, 10, 25, 0.7); border-color: #22D3EE; color: #A5F3FC; }
        .cyberpunk-theme .btn-action { background-color: #A3E635; color: #0C1445; }
        .cyberpunk-theme .btn-action:hover { background-color: #BEF264; }
        .cyberpunk-theme .stats-value.positive, .cyberpunk-theme .profit-positive { color: #22D3EE; }
        .cyberpunk-theme .stats-value.negative, .cyberpunk-theme .profit-negative { color: #F472B6; }
        .cyberpunk-theme .icon-btn { color: #A5F3FC; }
        .cyberpunk-theme .icon-btn:hover { color: #fff; }
        .cyberpunk-theme .score-glow-positive { text-shadow: 0 0 15px rgba(34, 211, 238, 0.7); }
        .cyberpunk-theme .score-glow-negative { text-shadow: 0 0 15px rgba(244, 114, 182, 0.7); }
        .cyberpunk-theme .form-input { background-color: rgba(10, 10, 25, 0.8); border: 1px solid #22D3EE; color: #A5F3FC; }
        .cyberpunk-theme .form-input::placeholder { color: #67E8F9; }
        .cyberpunk-theme .ring-track { stroke: rgba(34, 211, 238, 0.3); }
        .cyberpunk-theme .ring-wins { stroke: #22D3EE; }
        .cyberpunk-theme .ring-losses { stroke: #F472B6; }
        .cyberpunk-theme .data-ring-text { color: #A5F3FC; }
        .cyberpunk-theme .stats-card { background-color: rgba(10, 10, 25, 0.8); border: 1px solid #22D3EE; }

        /* --- Forest Theme --- */
        .forest-theme { background: linear-gradient(to top, #1E2A2A, #07373E); color: #EAE7E2; font-family: 'Nunito', sans-serif; }
        .forest-theme .main-container { background-color: rgba(20, 40, 35, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(110, 231, 183, 0.2); }
        .forest-theme .header-text, .forest-theme .score-text { color: #EAE7E2; }
        .forest-theme .sub-text { color: #A3B1A9; }
        .forest-theme .btn-positive { background-color: #6EE7B7; color: #07373E; }
        .forest-theme .btn-positive:hover { background-color: #A7F3D0; }
        .forest-theme .btn-negative { background-color: #E57373; color: white; }
        .forest-theme .btn-negative:hover { background-color: #EF5350; }
        .forest-theme .btn-neutral { background-color: #8D6E63; color: white; }
        .forest-theme .btn-neutral:hover { background-color: #A1887F; }
        .forest-theme .btn-secondary, .forest-theme .btn-action, .forest-theme .dropdown, .forest-theme .history-item { background-color: rgba(20, 40, 35, 0.8); border-color: rgba(163, 177, 169, 0.4); color: #EAE7E2; }
        .forest-theme .btn-action { background-color: #8D6E63; color: white; }
        .forest-theme .btn-action:hover { background-color: #A1887F; }
        .forest-theme .stats-value.positive, .forest-theme .profit-positive { color: #6EE7B7; }
        .forest-theme .stats-value.negative, .forest-theme .profit-negative { color: #E57373; }
        .forest-theme .icon-btn { color: #A3B1A9; }
        .forest-theme .icon-btn:hover { color: #EAE7E2; }
        .forest-theme .score-glow-positive { text-shadow: 0 0 15px rgba(110, 231, 183, 0.5); }
        .forest-theme .score-glow-negative { text-shadow: 0 0 15px rgba(229, 115, 115, 0.5); }
        .forest-theme .form-input { background-color: rgba(20, 40, 35, 0.8); border: 1px solid #A3B1A9; color: #EAE7E2; }
        .forest-theme .form-input::placeholder { color: #A3B1A9; }
        .forest-theme .ring-track { stroke: rgba(163, 177, 169, 0.3); }
        .forest-theme .ring-wins { stroke: #6EE7B7; }
        .forest-theme .ring-losses { stroke: #E57373; }
        .forest-theme .data-ring-text { color: #EAE7E2; }
        .forest-theme .stats-card { background-color: rgba(20, 40, 35, 0.8); }

        /* --- Crimson Theme --- */
        .crimson-theme { background: linear-gradient(to top, #121212, #1C1C1C); color: #F5F5F5; font-family: 'Merriweather', serif; }
        .crimson-theme .main-container { background-color: rgba(40, 10, 15, 0.6); backdrop-filter: blur(10px); border: 2px solid #DC2626; }
        .crimson-theme .header-text, .crimson-theme .score-text { color: #F5F5F5; }
        .crimson-theme .sub-text { color: #D4AF37; }
        .crimson-theme .btn-positive { background-color: #B91C1C; color: white; }
        .crimson-theme .btn-positive:hover { background-color: #991B1B; }
        .crimson-theme .btn-negative { background-color: #4B5563; color: white; }
        .crimson-theme .btn-negative:hover { background-color: #374151; }
        .crimson-theme .btn-neutral { background-color: #D4AF37; color: #1C1C1C; }
        .crimson-theme .btn-neutral:hover { background-color: #ca9f22; }
        .crimson-theme .btn-secondary, .crimson-theme .btn-action, .crimson-theme .dropdown, .crimson-theme .history-item { background-color: rgba(28, 28, 28, 0.8); border-color: rgba(212, 175, 55, 0.4); color: #F5F5F5; }
        .crimson-theme .btn-action { background-color: #D4AF37; color: #1C1C1C; }
        .crimson-theme .btn-action:hover { background-color: #ca9f22; }
        .crimson-theme .stats-value.positive, .crimson-theme .profit-positive { color: #B91C1C; }
        .crimson-theme .stats-value.negative, .crimson-theme .profit-negative { color: #9CA3AF; }
        .crimson-theme .icon-btn { color: #D4AF37; }
        .crimson-theme .icon-btn:hover { color: #F5F5F5; }
        .crimson-theme .score-glow-positive { text-shadow: 0 0 15px rgba(185, 28, 28, 0.6); }
        .crimson-theme .score-glow-negative { text-shadow: 0 0 15px rgba(156, 163, 175, 0.5); }
        .crimson-theme .form-input { background-color: rgba(28, 28, 28, 0.8); border: 1px solid #D4AF37; color: #F5F5F5; }
        .crimson-theme .form-input::placeholder { color: #D4AF37; }
        .crimson-theme .ring-track { stroke: rgba(212, 175, 55, 0.3); }
        .crimson-theme .ring-wins { stroke: #B91C1C; }
        .crimson-theme .ring-losses { stroke: #4B5563; }
        .crimson-theme .data-ring-text { color: #F5F5F5; }
        .crimson-theme .stats-card { background-color: rgba(28, 28, 28, 0.8); }

        /* --- Blueprint Theme --- */
        .blueprint-theme { background: #0A2240; color: #FFFFFF; font-family: 'Roboto Mono', monospace; }
        .blueprint-theme .main-container { background-color: rgba(5, 20, 45, 0.6); backdrop-filter: blur(8px); border: 2px solid #7DD3FC; }
        .blueprint-theme .header-text, .blueprint-theme .score-text { color: #FFFFFF; }
        .blueprint-theme .sub-text { color: #7DD3FC; }
        .blueprint-theme .btn-positive { background-color: #4ADE80; color: #0A2240; }
        .blueprint-theme .btn-positive:hover { background-color: #36D399; }
        .blueprint-theme .btn-negative { background-color: #FACC15; color: #0A2240; }
        .blueprint-theme .btn-negative:hover { background-color: #EAB308; }
        .blueprint-theme .btn-neutral { background-color: #FFFFFF; color: #0A2240; }
        .blueprint-theme .btn-neutral:hover { background-color: #E5E7EB; }
        .blueprint-theme .btn-secondary, .blueprint-theme .btn-action, .blueprint-theme .dropdown, .blueprint-theme .history-item { background-color: rgba(5, 20, 45, 0.8); border-color: #7DD3FC; color: #FFFFFF; }
        .blueprint-theme .btn-action { background-color: #FFFFFF; color: #0A2240; }
        .blueprint-theme .btn-action:hover { background-color: #E5E7EB; }
        .blueprint-theme .stats-value.positive, .blueprint-theme .profit-positive { color: #4ADE80; }
        .blueprint-theme .stats-value.negative, .blueprint-theme .profit-negative { color: #FACC15; }
        .blueprint-theme .icon-btn { color: #7DD3FC; }
        .blueprint-theme .icon-btn:hover { color: #FFFFFF; }
        .blueprint-theme .score-glow-positive { text-shadow: 0 0 15px rgba(74, 222, 128, 0.6); }
        .blueprint-theme .score-glow-negative { text-shadow: 0 0 15px rgba(250, 204, 21, 0.6); }
        .blueprint-theme .form-input { background-color: rgba(5, 20, 45, 0.8); border: 1px solid #7DD3FC; color: #FFFFFF; }
        .blueprint-theme .form-input::placeholder { color: #7DD3FC; }
        .blueprint-theme .ring-track { stroke: rgba(125, 211, 252, 0.3); }
        .blueprint-theme .ring-wins { stroke: #4ADE80; }
        .blueprint-theme .ring-losses { stroke: #FACC15; }
        .blueprint-theme .data-ring-text { color: #FFFFFF; }
        .blueprint-theme .stats-card { background-color: rgba(5, 20, 45, 0.8); }

        /* --- Monochrome Theme --- */
        .monochrome-theme { background-color: #F3F4F6; color: #111827; font-family: 'Inter', sans-serif; }
        .monochrome-theme .main-container { background-color: #FFFFFF; border: 1px solid #D1D5DB; }
        .monochrome-theme .header-text, .monochrome-theme .score-text { color: #111827; }
        .monochrome-theme .sub-text { color: #6B7280; }
        .monochrome-theme .btn-positive { background-color: #111827; color: #FFFFFF; }
        .monochrome-theme .btn-positive:hover { background-color: #374151; }
        .monochrome-theme .btn-negative { background-color: #E5E7EB; color: #111827; }
        .monochrome-theme .btn-negative:hover { background-color: #D1D5DB; }
        .monochrome-theme .btn-neutral { background-color: #FFFFFF; color: #111827; border: 2px solid #111827; }
        .monochrome-theme .btn-neutral:hover { background-color: #F9FAFB; }
        .monochrome-theme .btn-secondary, .monochrome-theme .btn-action, .monochrome-theme .dropdown, .monochrome-theme .history-item { background-color: #FFFFFF; border: 1px solid #D1D5DB; color: #111827; }
        .monochrome-theme .btn-action { background-color: #111827; color: #FFFFFF; }
        .monochrome-theme .btn-action:hover { background-color: #374151; }
        .monochrome-theme .stats-value.positive, .monochrome-theme .profit-positive { color: #111827; }
        .monochrome-theme .stats-value.negative, .monochrome-theme .profit-negative { color: #6B7280; }
        .monochrome-theme .icon-btn { color: #6B7280; }
        .monochrome-theme .icon-btn:hover { color: #111827; }
        .monochrome-theme .score-glow-positive { text-shadow: none; }
        .monochrome-theme .score-glow-negative { text-shadow: none; }
        .monochrome-theme .form-input { background-color: #F9FAFB; border: 1px solid #D1D5DB; color: #111827; }
        .monochrome-theme .form-input::placeholder { color: #9CA3AF; }
        .monochrome-theme .ring-track { stroke: #E5E7EB; }
        .monochrome-theme .ring-wins { stroke: #111827; }
        .monochrome-theme .ring-losses { stroke: #9CA3AF; }
        .monochrome-theme .data-ring-text { color: #111827; }
        .monochrome-theme .stats-card { background-color: #F9FAFB; }
        
        /* --- Oceanic Theme --- */
        .oceanic-theme { background: linear-gradient(to top, #021024, #08203e); color: #E0E7FF; font-family: 'Source Sans Pro', sans-serif; }
        .oceanic-theme .main-container { background-color: rgba(10, 30, 60, 0.6); backdrop-filter: blur(10px); border: 2px solid #64ffda; }
        .oceanic-theme .header-text, .oceanic-theme .score-text { color: #E0E7FF; }
        .oceanic-theme .sub-text { color: #64ffda; }
        .oceanic-theme .btn-positive { background-color: #FF7F50; color: #021024; }
        .oceanic-theme .btn-positive:hover { background-color: #FF6347; }
        .oceanic-theme .btn-negative { background-color: #4f8fc0; color: white; }
        .oceanic-theme .btn-negative:hover { background-color: #4682B4; }
        .oceanic-theme .btn-neutral { background-color: #64ffda; color: #021024; }
        .oceanic-theme .btn-neutral:hover { background-color: #59e3c4; }
        .oceanic-theme .btn-secondary, .oceanic-theme .btn-action, .oceanic-theme .dropdown, .oceanic-theme .history-item { background-color: rgba(10, 30, 60, 0.8); border-color: #64ffda; color: #E0E7FF; }
        .oceanic-theme .btn-action { background-color: #64ffda; color: #021024; }
        .oceanic-theme .btn-action:hover { background-color: #59e3c4; }
        .oceanic-theme .stats-value.positive, .oceanic-theme .profit-positive { color: #FF7F50; }
        .oceanic-theme .stats-value.negative, .oceanic-theme .profit-negative { color: #4f8fc0; }
        .oceanic-theme .icon-btn { color: #64ffda; }
        .oceanic-theme .icon-btn:hover { color: #E0E7FF; }
        .oceanic-theme .score-glow-positive { text-shadow: 0 0 15px rgba(255, 127, 80, 0.6); }
        .oceanic-theme .score-glow-negative { text-shadow: 0 0 15px rgba(79, 143, 192, 0.6); }
        .oceanic-theme .form-input { background-color: rgba(10, 30, 60, 0.8); border: 1px solid #64ffda; color: #E0E7FF; }
        .oceanic-theme .form-input::placeholder { color: #64ffda; }
        .oceanic-theme .ring-track { stroke: rgba(100, 255, 218, 0.3); }
        .oceanic-theme .ring-wins { stroke: #FF7F50; }
        .oceanic-theme .ring-losses { stroke: #4f8fc0; }
        .oceanic-theme .data-ring-text { color: #E0E7FF; }
        .oceanic-theme .stats-card { background-color: rgba(10, 30, 60, 0.8); }

        /* --- Iridescent Theme --- */
        .iridescent-theme { background: linear-gradient(45deg, #a7f3d0, #bae6fd, #fbcfe8, #fef08a); color: #581c87; font-family: 'Poppins', sans-serif; }
        .iridescent-theme .main-container { background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.8); }
        .iridescent-theme .header-text, .iridescent-theme .score-text { color: #581c87; }
        .iridescent-theme .sub-text { color: #0f766e; }
        .iridescent-theme .btn-positive { background-color: rgba(167, 243, 208, 0.7); color: #064e3b; border-color: #a7f3d0; }
        .iridescent-theme .btn-positive:hover { background-color: rgba(167, 243, 208, 1); }
        .iridescent-theme .btn-negative { background-color: rgba(251, 207, 232, 0.7); color: #831843; border-color: #fbcfe8; }
        .iridescent-theme .btn-negative:hover { background-color: rgba(251, 207, 232, 1); }
        .iridescent-theme .btn-neutral { background-color: rgba(216, 180, 254, 0.7); color: #581c87; border-color: #d8b4fe; }
        .iridescent-theme .btn-neutral:hover { background-color: rgba(216, 180, 254, 1); }
        .iridescent-theme .btn-secondary, .iridescent-theme .btn-action, .iridescent-theme .dropdown, .iridescent-theme .history-item { background-color: rgba(255, 255, 255, 0.4); border-color: rgba(15, 118, 110, 0.2); color: #0f766e; }
        .iridescent-theme .btn-action { background-color: rgba(216, 180, 254, 0.8); color: #581c87; }
        .iridescent-theme .btn-action:hover { background-color: rgba(216, 180, 254, 1); }
        .iridescent-theme .stats-value.positive, .iridescent-theme .profit-positive { color: #065f46; }
        .iridescent-theme .stats-value.negative, .iridescent-theme .profit-negative { color: #9d174d; }
        .iridescent-theme .icon-btn { color: #0f766e; }
        .iridescent-theme .icon-btn:hover { color: #581c87; }
        .iridescent-theme .score-glow-positive { text-shadow: 0 0 10px rgba(52, 211, 153, 0.7); }
        .iridescent-theme .score-glow-negative { text-shadow: 0 0 10px rgba(251, 146, 198, 0.7); }
        .iridescent-theme .form-input { background-color: rgba(255, 255, 255, 0.5); border: 1px solid rgba(15, 118, 110, 0.3); color: #581c87; }
        .iridescent-theme .form-input::placeholder { color: #115e59; }
        .iridescent-theme .ring-track { stroke: rgba(15, 118, 110, 0.2); }
        .iridescent-theme .ring-wins { stroke: #a7f3d0; }
        .iridescent-theme .ring-losses { stroke: #fbcfe8; }
        .iridescent-theme .data-ring-text { color: #581c87; }
        .iridescent-theme .stats-card { background-color: rgba(255, 255, 255, 0.5); }
        
        /* --- Nebula Theme --- */
        .nebula-theme { background: linear-gradient(45deg, #1E1B4B, #86198F, #134E4A); color: #F0F9FF; font-family: 'Exo 2', sans-serif; }
        .nebula-theme .main-container { background-color: rgba(10, 10, 20, 0.5); backdrop-filter: blur(12px); border: 2px solid #A855F7; }
        .nebula-theme .header-text, .nebula-theme .score-text { color: #F0F9FF; }
        .nebula-theme .sub-text { color: #A855F7; }
        .nebula-theme .btn-positive { background-color: #14B8A6; color: #F0F9FF; }
        .nebula-theme .btn-positive:hover { background-color: #0D9488; }
        .nebula-theme .btn-negative { background-color: #D946EF; color: #F0F9FF; }
        .nebula-theme .btn-negative:hover { background-color: #C026D3; }
        .nebula-theme .btn-neutral { background-color: #6366F1; color: #F0F9FF; }
        .nebula-theme .btn-neutral:hover { background-color: #4F46E5; }
        .nebula-theme .btn-secondary, .nebula-theme .btn-action, .nebula-theme .dropdown, .nebula-theme .history-item { background-color: rgba(10, 10, 20, 0.7); border-color: rgba(168, 85, 247, 0.5); color: #F0F9FF; }
        .nebula-theme .btn-action { background-color: #6366F1; color: #F0F9FF; }
        .nebula-theme .btn-action:hover { background-color: #4F46E5; }
        .nebula-theme .stats-value.positive, .nebula-theme .profit-positive { color: #14B8A6; }
        .nebula-theme .stats-value.negative, .nebula-theme .profit-negative { color: #D946EF; }
        .nebula-theme .icon-btn { color: #A855F7; }
        .nebula-theme .icon-btn:hover { color: #F0F9FF; }
        .nebula-theme .score-glow-positive { text-shadow: 0 0 10px #14B8A6; }
        .nebula-theme .score-glow-negative { text-shadow: 0 0 10px #D946EF; }
        .nebula-theme .form-input { background-color: rgba(10, 10, 20, 0.7); border: 1px solid #A855F7; color: #F0F9FF; }
        .nebula-theme .form-input::placeholder { color: #A855F7; }
        .nebula-theme .ring-track { stroke: rgba(168, 85, 247, 0.3); }
        .nebula-theme .ring-wins { stroke: #14B8A6; }
        .nebula-theme .ring-losses { stroke: #D946EF; }
        .nebula-theme .data-ring-text { color: #F0F9FF; }
        .nebula-theme .stats-card { background-color: rgba(10, 10, 20, 0.7); }

        /* --- Supernova Theme --- */
        .supernova-theme { background: linear-gradient(45deg, #1E293B, #86198F, #B45309); color: #FFFBEB; font-family: 'Space Mono', monospace; }
        .supernova-theme .main-container { background-color: rgba(20, 20, 20, 0.6); backdrop-filter: blur(12px); border: 2px solid #FACC15; }
        .supernova-theme .header-text, .supernova-theme .score-text { color: #FFFBEB; }
        .supernova-theme .sub-text { color: #FACC15; }
        .supernova-theme .btn-positive { background-color: #F97316; color: #FFFBEB; }
        .supernova-theme .btn-positive:hover { background-color: #EA580C; }
        .supernova-theme .btn-negative { background-color: #4F46E5; color: #FFFBEB; }
        .supernova-theme .btn-negative:hover { background-color: #4338CA; }
        .supernova-theme .btn-neutral { background-color: #FACC15; color: #1E293B; }
        .supernova-theme .btn-neutral:hover { background-color: #EAB308; }
        .supernova-theme .btn-secondary, .supernova-theme .btn-action, .supernova-theme .dropdown, .supernova-theme .history-item { background-color: rgba(20, 20, 20, 0.7); border-color: rgba(250, 204, 21, 0.5); color: #FFFBEB; }
        .supernova-theme .btn-action { background-color: #FACC15; color: #1E293B; }
        .supernova-theme .btn-action:hover { background-color: #EAB308; }
        .supernova-theme .stats-value.positive, .supernova-theme .profit-positive { color: #F97316; }
        .supernova-theme .stats-value.negative, .supernova-theme .profit-negative { color: #4F46E5; }
        .supernova-theme .icon-btn { color: #FACC15; }
        .supernova-theme .icon-btn:hover { color: #FFFBEB; }
        .supernova-theme .score-glow-positive { text-shadow: 0 0 10px #F97316; }
        .supernova-theme .score-glow-negative { text-shadow: 0 0 10px #4F46E5; }
        .supernova-theme .form-input { background-color: rgba(20, 20, 20, 0.7); border: 1px solid #FACC15; color: #FFFBEB; }
        .supernova-theme .form-input::placeholder { color: #FACC15; }
        .supernova-theme .ring-track { stroke: rgba(250, 204, 21, 0.3); }
        .supernova-theme .ring-wins { stroke: #F97316; }
        .supernova-theme .ring-losses { stroke: #4F46E5; }
        .supernova-theme .data-ring-text { color: #FFFBEB; }
        .supernova-theme .stats-card { background-color: rgba(20, 20, 20, 0.7); }
        
        /* --- Nocturne Theme --- */
        .nocturne-theme { background: linear-gradient(to top, #191970, #4B0000, #003300); color: #E5E5E5; font-family: 'DM Sans', sans-serif; }
        .nocturne-theme .main-container { background-color: rgba(10, 10, 10, 0.6); backdrop-filter: blur(14px); border: 2px solid #8B0000; }
        .nocturne-theme .header-text, .nocturne-theme .score-text { color: #E5E5E5; }
        .nocturne-theme .sub-text { color: #48D1CC; }
        .nocturne-theme .btn-positive { background-color: #006400; color: #E5E5E5; }
        .nocturne-theme .btn-positive:hover { background-color: #008000; }
        .nocturne-theme .btn-negative { background-color: #8B0000; color: #E5E5E5; }
        .nocturne-theme .btn-negative:hover { background-color: #A52A2A; }
        .nocturne-theme .btn-neutral { background-color: #4169E1; color: #E5E5E5; }
        .nocturne-theme .btn-neutral:hover { background-color: #6495ED; }
        .nocturne-theme .btn-secondary, .nocturne-theme .btn-action, .nocturne-theme .dropdown, .nocturne-theme .history-item { background-color: rgba(10, 10, 10, 0.8); border-color: rgba(72, 209, 204, 0.4); color: #E5E5E5; }
        .nocturne-theme .btn-action { background-color: #4169E1; color: #E5E5E5; }
        .nocturne-theme .btn-action:hover { background-color: #6495ED; }
        .nocturne-theme .stats-value.positive, .nocturne-theme .profit-positive { color: #006400; }
        .nocturne-theme .stats-value.negative, .nocturne-theme .profit-negative { color: #8B0000; }
        .nocturne-theme .icon-btn { color: #48D1CC; }
        .nocturne-theme .icon-btn:hover { color: #E5E5E5; }
        .nocturne-theme .score-glow-positive { text-shadow: 0 0 10px #006400; }
        .nocturne-theme .score-glow-negative { text-shadow: 0 0 10px #8B0000; }
        .nocturne-theme .form-input { background-color: rgba(10, 10, 10, 0.8); border: 1px solid #48D1CC; color: #E5E5E5; }
        .nocturne-theme .form-input::placeholder { color: #48D1CC; }
        .nocturne-theme .ring-track { stroke: rgba(72, 209, 204, 0.3); }
        .nocturne-theme .ring-wins { stroke: #006400; }
        .nocturne-theme .ring-losses { stroke: #8B0000; }
        .nocturne-theme .data-ring-text { color: #E5E5E5; }
        .nocturne-theme .stats-card { background-color: rgba(10, 10, 10, 0.8); }

        /* --- Obsidian Theme --- */
        .obsidian-theme { background: radial-gradient(circle, #1F1F1F, #000000); color: #FFFFFF; font-family: 'IBM Plex Mono', monospace; }
        .obsidian-theme .main-container { background-color: rgba(28, 28, 30, 0.5); backdrop-filter: blur(14px); border: 1px solid #E5E5E5; }
        .obsidian-theme .header-text, .obsidian-theme .score-text { color: #FFFFFF; }
        .obsidian-theme .sub-text { color: #A1A1AA; }
        .obsidian-theme .btn-positive { background-color: #38BDF8; color: #000000; }
        .obsidian-theme .btn-positive:hover { background-color: #0EA5E9; }
        .obsidian-theme .btn-negative { background-color: #3F3F46; color: #E5E5E5; }
        .obsidian-theme .btn-negative:hover { background-color: #52525B; }
        .obsidian-theme .btn-neutral { background-color: #FFFFFF; color: #000000; }
        .obsidian-theme .btn-neutral:hover { background-color: #E5E5E5; }
        .obsidian-theme .btn-secondary, .obsidian-theme .btn-action, .obsidian-theme .dropdown, .obsidian-theme .history-item { background-color: rgba(28, 28, 30, 0.8); border-color: #A1A1AA; color: #FFFFFF; }
        .obsidian-theme .btn-action { background-color: #FFFFFF; color: #000000; }
        .obsidian-theme .btn-action:hover { background-color: #E5E5E5; }
        .obsidian-theme .stats-value.positive, .obsidian-theme .profit-positive { color: #38BDF8; }
        .obsidian-theme .stats-value.negative, .obsidian-theme .profit-negative { color: #A1A1AA; }
        .obsidian-theme .icon-btn { color: #A1A1AA; }
        .obsidian-theme .icon-btn:hover { color: #FFFFFF; }
        .obsidian-theme .score-glow-positive { text-shadow: 0 0 8px #38BDF8; }
        .obsidian-theme .score-glow-negative { text-shadow: none; }
        .obsidian-theme .form-input { background-color: rgba(28, 28, 30, 0.8); border: 1px solid #A1A1AA; color: #FFFFFF; }
        .obsidian-theme .form-input::placeholder { color: #A1A1AA; }
        .obsidian-theme .ring-track { stroke: #3F3F46; }
        .obsidian-theme .ring-wins { stroke: #38BDF8; }
        .obsidian-theme .ring-losses { stroke: #A1A1AA; }
        .obsidian-theme .data-ring-text { color: #FFFFFF; }
        .obsidian-theme .stats-card { background-color: rgba(28, 28, 30, 0.8); }
        
        /* --- Emerald Theme --- */
        .emerald-theme { background: linear-gradient(to top, #010201, #051412); color: #E2E8F0; font-family: 'JetBrains Mono', monospace; }
        .emerald-theme .main-container { background-color: rgba(15, 23, 42, 0.5); backdrop-filter: blur(12px); border: 2px solid #10B981; }
        .emerald-theme .header-text, .emerald-theme .score-text { color: #E2E8F0; }
        .emerald-theme .sub-text { color: #10B981; }
        .emerald-theme .btn-positive { background-color: #10B981; color: #051412; }
        .emerald-theme .btn-positive:hover { background-color: #059669; }
        .emerald-theme .btn-negative { background-color: #3730A3; color: #E2E8F0; }
        .emerald-theme .btn-negative:hover { background-color: #4338CA; }
        .emerald-theme .btn-neutral { background-color: #334155; color: #E2E8F0; }
        .emerald-theme .btn-neutral:hover { background-color: #475569; }
        .emerald-theme .btn-secondary, .emerald-theme .btn-action, .emerald-theme .dropdown, .emerald-theme .history-item { background-color: rgba(15, 23, 42, 0.7); border-color: #10B981; color: #E2E8F0; }
        .emerald-theme .btn-action { background-color: #334155; color: #E2E8F0; }
        .emerald-theme .btn-action:hover { background-color: #475569; }
        .emerald-theme .stats-value.positive, .emerald-theme .profit-positive { color: #10B981; }
        .emerald-theme .stats-value.negative, .emerald-theme .profit-negative { color: #3730A3; }
        .emerald-theme .icon-btn { color: #10B981; }
        .emerald-theme .icon-btn:hover { color: #E2E8F0; }
        .emerald-theme .score-glow-positive { text-shadow: 0 0 10px #10B981; }
        .emerald-theme .score-glow-negative { text-shadow: 0 0 10px #3730A3; }
        .emerald-theme .form-input { background-color: rgba(15, 23, 42, 0.7); border: 1px solid #10B981; color: #E2E8F0; }
        .emerald-theme .form-input::placeholder { color: #10B981; }
        .emerald-theme .ring-track { stroke: rgba(16, 185, 129, 0.3); }
        .emerald-theme .ring-wins { stroke: #10B981; }
        .emerald-theme .ring-losses { stroke: #3730A3; }
        .emerald-theme .data-ring-text { color: #E2E8F0; }
        .emerald-theme .stats-card { background-color: rgba(15, 23, 42, 0.7); }

        /* --- Volcano Theme --- */
        .volcano-theme { background: linear-gradient(to top, #000000, #4C1D1D, #2D080A); color: #FFF7ED; font-family: 'Russo One', sans-serif; }
        .volcano-theme .main-container { background-color: rgba(15, 15, 15, 0.6); backdrop-filter: blur(12px); border: 2px solid #FF4500; }
        .volcano-theme .header-text, .volcano-theme .score-text { color: #FFF7ED; }
        .volcano-theme .sub-text { color: #FF4500; }
        .volcano-theme .btn-positive { background-color: #DC2626; color: #FFF7ED; }
        .volcano-theme .btn-positive:hover { background-color: #B91C1C; }
        .volcano-theme .btn-negative { background-color: #36454F; color: #FFF7ED; }
        .volcano-theme .btn-negative:hover { background-color: #475569; }
        .volcano-theme .btn-neutral { background-color: #FF8C00; color: #000000; }
        .volcano-theme .btn-neutral:hover { background-color: #FFA500; }
        .volcano-theme .btn-secondary, .volcano-theme .btn-action, .volcano-theme .dropdown, .volcano-theme .history-item { background-color: rgba(15, 15, 15, 0.8); border-color: rgba(255, 69, 0, 0.5); color: #FFF7ED; }
        .volcano-theme .btn-action { background-color: #FF8C00; color: #000000; }
        .volcano-theme .btn-action:hover { background-color: #FFA500; }
        .volcano-theme .stats-value.positive, .volcano-theme .profit-positive { color: #DC2626; }
        .volcano-theme .stats-value.negative, .volcano-theme .profit-negative { color: #36454F; }
        .volcano-theme .icon-btn { color: #FF4500; }
        .volcano-theme .icon-btn:hover { color: #FFF7ED; }
        .volcano-theme .score-glow-positive { text-shadow: 0 0 10px #DC2626; }
        .volcano-theme .score-glow-negative { text-shadow: 0 0 10px #36454F; }
        .volcano-theme .form-input { background-color: rgba(15, 15, 15, 0.8); border: 1px solid #FF4500; color: #FFF7ED; }
        .volcano-theme .form-input::placeholder { color: #FF4500; }
        .volcano-theme .ring-track { stroke: rgba(255, 69, 0, 0.3); }
        .volcano-theme .ring-wins { stroke: #DC2626; }
        .volcano-theme .ring-losses { stroke: #36454F; }
        .volcano-theme .data-ring-text { color: #FFF7ED; }
        .volcano-theme .stats-card { background-color: rgba(15, 15, 15, 0.8); }

        /* --- Phantom Theme --- */
        .phantom-theme { background: radial-gradient(circle, #222222, #000000); color: #FFFFFF; font-family: 'Inter', sans-serif; }
        .phantom-theme .main-container { background-color: rgba(30, 30, 30, 0.4); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .phantom-theme .header-text, .phantom-theme .score-text { color: #FFFFFF; }
        .phantom-theme .sub-text { color: #A0A0A0; }
        .phantom-theme .btn-positive { background: linear-gradient(to top right, #9CA3AF, #E5E7EB); color: #000000; }
        .phantom-theme .btn-positive:hover { background: linear-gradient(to top right, #B0B5B9, #FFFFFF); }
        .phantom-theme .btn-negative { background: linear-gradient(to top right, #1F2937, #4B5563); color: #A0A0A0; }
        .phantom-theme .btn-negative:hover { background: linear-gradient(to top right, #374151, #6B7280); }
        .phantom-theme .btn-neutral { background-color: #6B7280; color: #FFFFFF; }
        .phantom-theme .btn-neutral:hover { background-color: #4B5563; }
        .phantom-theme .btn-secondary, .phantom-theme .btn-action, .phantom-theme .dropdown, .phantom-theme .history-item { background-color: rgba(28, 28, 30, 0.8); border-color: #A1A1AA; color: #FFFFFF; }
        .phantom-theme .btn-action { background-color: #FFFFFF; color: #000000; }
        .phantom-theme .btn-action:hover { background-color: #E5E5E5; }
        .phantom-theme .stats-value.positive, .phantom-theme .profit-positive { color: #9CA3AF; }
        .phantom-theme .stats-value.negative, .phantom-theme .profit-negative { color: #4B5563; }
        .phantom-theme .icon-btn { color: #A0A0A0; }
        .phantom-theme .icon-btn:hover { color: #FFFFFF; }
        .phantom-theme .score-glow-positive { text-shadow: none; }
        .phantom-theme .score-glow-negative { text-shadow: none; }
        .phantom-theme .form-input { background-color: rgba(28, 28, 30, 0.8); border: 1px solid #A1A1AA; color: #FFFFFF; }
        .phantom-theme .form-input::placeholder { color: #A1A1AA; }
        .phantom-theme .ring-track { stroke: #374151; }
        .phantom-theme .ring-wins { stroke: #9CA3AF; }
        .phantom-theme .ring-losses { stroke: #4B5563; }
        .phantom-theme .data-ring-text { color: #FFFFFF; }
        .phantom-theme .stats-card { background-color: rgba(28, 28, 30, 0.8); }

        /* --- Carbon Theme --- */
        .carbon-theme { background: linear-gradient(45deg, #111111, #333333); color: #FFFFFF; font-family: 'Oxanium', sans-serif; }
        .carbon-theme .main-container { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(14px); border: 2px solid #EF4444; }
        .carbon-theme .header-text, .carbon-theme .score-text { color: #FFFFFF; }
        .carbon-theme .sub-text { color: #EF4444; }
        .carbon-theme .btn-positive { background-color: #EF4444; color: #FFFFFF; }
        .carbon-theme .btn-positive:hover { background-color: #DC2626; }
        .carbon-theme .btn-negative { background: linear-gradient(to top right, #222, #444); color: #E5E5E5; }
        .carbon-theme .btn-negative:hover { background: linear-gradient(to top right, #333, #555); }
        .carbon-theme .btn-neutral { background: linear-gradient(to top right, #888, #BBB); color: #000000; }
        .carbon-theme .btn-neutral:hover { background: linear-gradient(to top right, #999, #CCC); }
        .carbon-theme .btn-secondary, .carbon-theme .btn-action, .carbon-theme .dropdown, .carbon-theme .history-item { background-color: rgba(0, 0, 0, 0.7); border-color: #EF4444; color: #FFFFFF; }
        .carbon-theme .btn-action { background: linear-gradient(to top right, #888, #BBB); color: #000000; }
        .carbon-theme .btn-action:hover { background: linear-gradient(to top right, #999, #CCC); }
        .carbon-theme .stats-value.positive, .carbon-theme .profit-positive { color: #EF4444; }
        .carbon-theme .stats-value.negative, .carbon-theme .profit-negative { color: #9CA3AF; }
        .carbon-theme .icon-btn { color: #EF4444; }
        .carbon-theme .icon-btn:hover { color: #FFFFFF; }
        .carbon-theme .score-glow-positive { text-shadow: 0 0 10px #EF4444; }
        .carbon-theme .score-glow-negative { text-shadow: none; }
        .carbon-theme .form-input { background-color: rgba(0, 0, 0, 0.7); border: 1px solid #EF4444; color: #FFFFFF; }
        .carbon-theme .form-input::placeholder { color: #EF4444; }
        .carbon-theme .ring-track { stroke: #333333; }
        .carbon-theme .ring-wins { stroke: #EF4444; }
        .carbon-theme .ring-losses { stroke: #444; }
        .carbon-theme .data-ring-text { color: #FFFFFF; }
        .carbon-theme .stats-card { background-color: rgba(0, 0, 0, 0.7); }

        /* --- Aura Theme --- */
        .aura-theme { background: linear-gradient(45deg, #FFDDE1, #EE9CA7, #C6EA8D); color: #444444; font-family: 'Montserrat', sans-serif; }
        .aura-theme .main-container { background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(16px); border: 1px solid #A78BFA; }
        .aura-theme .header-text, .aura-theme .score-text { color: #444444; }
        .aura-theme .sub-text { color: #A78BFA; }
        .aura-theme .btn-positive { background-color: #FFDAB9; color: #444444; }
        .aura-theme .btn-positive:hover { background-color: #FFC0CB; }
        .aura-theme .btn-negative { background-color: #ADD8E6; color: #444444; }
        .aura-theme .btn-negative:hover { background-color: #87CEEB; }
        .aura-theme .btn-neutral { background-color: #A78BFA; color: white; }
        .aura-theme .btn-neutral:hover { background-color: #8B5CF6; }
        .aura-theme .btn-secondary, .aura-theme .btn-action, .aura-theme .dropdown, .aura-theme .history-item { background-color: rgba(255, 255, 255, 0.6); border-color: #A78BFA; color: #444444; }
        .aura-theme .btn-action { background-color: #A78BFA; color: white; }
        .aura-theme .btn-action:hover { background-color: #8B5CF6; }
        .aura-theme .stats-value.positive, .aura-theme .profit-positive { color: #FFDAB9; }
        .aura-theme .stats-value.negative, .aura-theme .profit-negative { color: #ADD8E6; }
        .aura-theme .icon-btn { color: #A78BFA; }
        .aura-theme .icon-btn:hover { color: #444444; }
        .aura-theme .score-glow-positive { text-shadow: 0 0 10px #FFDAB9; }
        .aura-theme .score-glow-negative { text-shadow: 0 0 10px #ADD8E6; }
        .aura-theme .form-input { background-color: rgba(255, 255, 255, 0.6); border: 1px solid #A78BFA; color: #444444; }
        .aura-theme .form-input::placeholder { color: #A78BFA; }
        .aura-theme .ring-track { stroke: rgba(167, 139, 250, 0.3); }
        .aura-theme .ring-wins { stroke: #FFDAB9; }
        .aura-theme .ring-losses { stroke: #ADD8E6; }
        .aura-theme .data-ring-text { color: #444444; }
        .aura-theme .stats-card { background-color: rgba(255, 255, 255, 0.6); }
        
        /* --- Frostfire Theme --- */
        .frostfire-theme { background: linear-gradient(to top, #3B82F6, #60A5FA); color: #FFFFFF; font-family: 'Orbitron', sans-serif; }
        .frostfire-theme .main-container { background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(12px); border: 2px solid #F97316; }
        .frostfire-theme .header-text, .frostfire-theme .score-text { color: #FFFFFF; }
        .frostfire-theme .sub-text { color: #F97316; }
        .frostfire-theme .btn-positive { background-color: #F97316; color: #FFFFFF; }
        .frostfire-theme .btn-positive:hover { background-color: #EA580C; }
        .frostfire-theme .btn-negative { background-color: #3B82F6; color: #FFFFFF; }
        .frostfire-theme .btn-negative:hover { background-color: #2563EB; }
        .frostfire-theme .btn-neutral { background-color: #F97316; color: #FFFFFF; }
        .frostfire-theme .btn-neutral:hover { background-color: #EA580C; }
        .frostfire-theme .btn-secondary, .frostfire-theme .btn-action, .frostfire-theme .dropdown, .frostfire-theme .history-item { background-color: rgba(255, 255, 255, 0.2); border-color: #F97316; color: #FFFFFF; }
        .frostfire-theme .btn-action { background-color: #F97316; color: #FFFFFF; }
        .frostfire-theme .btn-action:hover { background-color: #EA580C; }
        .frostfire-theme .stats-value.positive, .frostfire-theme .profit-positive { color: #F97316; }
        .frostfire-theme .stats-value.negative, .frostfire-theme .profit-negative { color: #60A5FA; }
        .frostfire-theme .icon-btn { color: #F97316; }
        .frostfire-theme .icon-btn:hover { color: #FFFFFF; }
        .frostfire-theme .score-glow-positive { text-shadow: 0 0 10px #F97316; }
        .frostfire-theme .score-glow-negative { text-shadow: 0 0 10px #60A5FA; }
        .frostfire-theme .form-input { background-color: rgba(255, 255, 255, 0.2); border: 1px solid #F97316; color: #FFFFFF; }
        .frostfire-theme .form-input::placeholder { color: #F97316; }
        .frostfire-theme .ring-track { stroke: rgba(249, 115, 22, 0.3); }
        .frostfire-theme .ring-wins { stroke: #F97316; }
        .frostfire-theme .ring-losses { stroke: #3B82F6; }
        .frostfire-theme .data-ring-text { color: #FFFFFF; }
        .frostfire-theme .stats-card { background-color: rgba(255, 255, 255, 0.2); }

        /* --- Gilded Theme --- */
        .gilded-theme { background: linear-gradient(to bottom, #1C1C1C, #111111); color: #EAEAEA; font-family: 'Cinzel', serif; }
        .gilded-theme .main-container { background-color: rgba(25, 25, 25, 0.5); backdrop-filter: blur(12px); border: 2px solid #E6B800; }
        .gilded-theme .header-text, .gilded-theme .score-text { color: #E6B800; }
        .gilded-theme .sub-text { color: #EAEAEA; }
        .gilded-theme .btn-positive { background-color: #000000; color: #E6B800; border: 1px solid #E6B800; }
        .gilded-theme .btn-positive:hover { background-color: #111111; }
        .gilded-theme .btn-negative { background-color: #333333; color: #A0A0A0; }
        .gilded-theme .btn-negative:hover { background-color: #444444; }
        .gilded-theme .btn-neutral { background: linear-gradient(to top right, #B8860B, #FFD700); color: #000000; }
        .gilded-theme .btn-neutral:hover { background: linear-gradient(to top right, #DAA520, #FFEC8B); }
        .gilded-theme .btn-secondary, .gilded-theme .btn-action, .gilded-theme .dropdown, .gilded-theme .history-item { background-color: rgba(25, 25, 25, 0.8); border-color: #E6B800; color: #EAEAEA; }
        .gilded-theme .btn-action { background: linear-gradient(to top right, #B8860B, #FFD700); color: #000000; }
        .gilded-theme .btn-action:hover { background: linear-gradient(to top right, #DAA520, #FFEC8B); }
        .gilded-theme .stats-value.positive, .gilded-theme .profit-positive { color: #E6B800; }
        .gilded-theme .stats-value.negative, .gilded-theme .profit-negative { color: #A0A0A0; }
        .gilded-theme .icon-btn { color: #E6B800; }
        .gilded-theme .icon-btn:hover { color: #FFF; }
        .gilded-theme .score-glow-positive { text-shadow: 0 0 10px #E6B800; }
        .gilded-theme .score-glow-negative { text-shadow: none; }
        .gilded-theme .form-input { background-color: rgba(25, 25, 25, 0.8); border: 1px solid #E6B800; color: #EAEAEA; }
        .gilded-theme .form-input::placeholder { color: #E6B800; }
        .gilded-theme .ring-track { stroke: #333333; }
        .gilded-theme .ring-wins { stroke: #E6B800; }
        .gilded-theme .ring-losses { stroke: #A0A0A0; }
        .gilded-theme .data-ring-text { color: #EAEAEA; }
        .gilded-theme .stats-card { background-color: rgba(25, 25, 25, 0.8); }

        /* --- Black Gold Theme --- */
        .black-gold-theme { background: linear-gradient(45deg, #121212, #282828); color: #F5F5F4; font-family: 'Cormorant Garamond', serif; }
        .black-gold-theme .main-container { background-color: rgba(20, 20, 20, 0.4); backdrop-filter: blur(12px); border: 2px solid #D4AF37; }
        .black-gold-theme .header-text, .black-gold-theme .score-text { color: #D4AF37; }
        .black-gold-theme .sub-text { color: #F5F5F4; }
        .black-gold-theme .btn-positive { background-color: #1C1917; color: #D4AF37; border: 1px solid #D4AF37; }
        .black-gold-theme .btn-positive:hover { background-color: #292524; }
        .black-gold-theme .btn-negative { background-color: #44403C; color: #A8A29E; }
        .black-gold-theme .btn-negative:hover { background-color: #57534E; }
        .black-gold-theme .btn-neutral { background-color: #D4AF37; color: #1C1917; }
        .black-gold-theme .btn-neutral:hover { background-color: #ca9f22; }
        .black-gold-theme .btn-secondary, .black-gold-theme .btn-action, .black-gold-theme .dropdown, .black-gold-theme .history-item { background-color: rgba(20, 20, 20, 0.8); border-color: #D4AF37; color: #F5F5F4; }
        .black-gold-theme .btn-action { background-color: #D4AF37; color: #1C1917; }
        .black-gold-theme .btn-action:hover { background-color: #ca9f22; }
        .black-gold-theme .stats-value.positive, .black-gold-theme .profit-positive { color: #D4AF37; }
        .black-gold-theme .stats-value.negative, .black-gold-theme .profit-negative { color: #A8A29E; }
        .black-gold-theme .icon-btn { color: #D4AF37; }
        .black-gold-theme .icon-btn:hover { color: #F5F5F4; }
        .black-gold-theme .score-glow-positive { text-shadow: 0 0 10px #D4AF37; }
        .black-gold-theme .score-glow-negative { text-shadow: none; }
        .black-gold-theme .form-input { background-color: rgba(20, 20, 20, 0.8); border: 1px solid #D4AF37; color: #F5F5F4; }
        .black-gold-theme .form-input::placeholder { color: #D4AF37; }
        .black-gold-theme .ring-track { stroke: #44403C; }
        .black-gold-theme .ring-wins { stroke: #D4AF37; }
        .black-gold-theme .ring-losses { stroke: #A8A29E; }
        .black-gold-theme .data-ring-text { color: #F5F5F4; }
        .black-gold-theme .stats-card { background-color: rgba(20, 20, 20, 0.8); }

        /* --- NEW: Midnight Bloom Theme --- */
        .midnight-bloom-theme { background: linear-gradient(to top, #0c0a2d, #1d1a3f); color: #e0e7ff; font-family: 'DM Sans', sans-serif; }
        .midnight-bloom-theme .main-container { background-color: rgba(29, 26, 63, 0.5); backdrop-filter: blur(16px); border: 2px solid #f43f5e; }
        .midnight-bloom-theme .header-text, .midnight-bloom-theme .score-text { color: #e0e7ff; }
        .midnight-bloom-theme .sub-text { color: #a78bfa; }
        .midnight-bloom-theme .btn-positive { background-color: #22d3ee; color: #1d1a3f; }
        .midnight-bloom-theme .btn-positive:hover { background-color: #67e8f9; }
        .midnight-bloom-theme .btn-negative { background-color: #f43f5e; color: #e0e7ff; }
        .midnight-bloom-theme .btn-negative:hover { background-color: #fb7185; }
        .midnight-bloom-theme .btn-neutral { background-color: #a78bfa; color: #1d1a3f; }
        .midnight-bloom-theme .btn-neutral:hover { background-color: #c4b5fd; }
        .midnight-bloom-theme .btn-secondary, .midnight-bloom-theme .btn-action, .midnight-bloom-theme .dropdown, .midnight-bloom-theme .history-item { background-color: rgba(29, 26, 63, 0.7); border-color: rgba(167, 139, 250, 0.4); color: #e0e7ff; }
        .midnight-bloom-theme .btn-action { background-color: #a78bfa; color: #1d1a3f; }
        .midnight-bloom-theme .btn-action:hover { background-color: #c4b5fd; }
        .midnight-bloom-theme .stats-value.positive, .midnight-bloom-theme .profit-positive { color: #22d3ee; }
        .midnight-bloom-theme .stats-value.negative, .midnight-bloom-theme .profit-negative { color: #f43f5e; }
        .midnight-bloom-theme .icon-btn { color: #a78bfa; }
        .midnight-bloom-theme .icon-btn:hover { color: #e0e7ff; }
        .midnight-bloom-theme .score-glow-positive { text-shadow: 0 0 15px rgba(34, 211, 238, 0.6); }
        .midnight-bloom-theme .score-glow-negative { text-shadow: 0 0 15px rgba(244, 63, 94, 0.6); }
        .midnight-bloom-theme .form-input { background-color: rgba(29, 26, 63, 0.7); border: 1px solid #a78bfa; color: #e0e7ff; }
        .midnight-bloom-theme .form-input::placeholder { color: #a78bfa; }
        .midnight-bloom-theme .ring-track { stroke: rgba(167, 139, 250, 0.3); }
        .midnight-bloom-theme .ring-wins { stroke: #22d3ee; }
        .midnight-bloom-theme .ring-losses { stroke: #f43f5e; }
        .midnight-bloom-theme .data-ring-text { color: #e0e7ff; }
        .midnight-bloom-theme .stats-card { background-color: rgba(29, 26, 63, 0.7); }

        /* --- NEW: Crystal Clear Theme --- */
        .crystal-clear-theme { background: linear-gradient(to top, #e0f2fe, #f0f9ff); color: #075985; font-family: 'Inter', sans-serif; }
        .crystal-clear-theme .main-container { background-color: rgba(255, 255, 255, 0.55); backdrop-filter: blur(16px); border: 1px solid rgba(0, 0, 0, 0.1); }
        .crystal-clear-theme .header-text, .crystal-clear-theme .score-text { color: #075985; }
        .crystal-clear-theme .sub-text { color: #0369a1; }
        .crystal-clear-theme .btn-positive { background-color: #16a34a; color: white; }
        .crystal-clear-theme .btn-positive:hover { background-color: #22c55e; }
        .crystal-clear-theme .btn-negative { background-color: #f97316; color: white; }
        .crystal-clear-theme .btn-negative:hover { background-color: #fb923c; }
        .crystal-clear-theme .btn-neutral { background-color: #6366f1; color: white; }
        .crystal-clear-theme .btn-neutral:hover { background-color: #818cf8; }
        .crystal-clear-theme .btn-secondary, .crystal-clear-theme .btn-action, .crystal-clear-theme .dropdown, .crystal-clear-theme .history-item { background-color: rgba(255, 255, 255, 0.7); border-color: rgba(3, 105, 161, 0.2); color: #075985; }
        .crystal-clear-theme .btn-action { background-color: #6366f1; color: white; }
        .crystal-clear-theme .btn-action:hover { background-color: #818cf8; }
        .crystal-clear-theme .stats-value.positive, .crystal-clear-theme .profit-positive { color: #16a34a; }
        .crystal-clear-theme .stats-value.negative, .crystal-clear-theme .profit-negative { color: #f97316; }
        .crystal-clear-theme .icon-btn { color: #0369a1; }
        .crystal-clear-theme .icon-btn:hover { color: #075985; }
        .crystal-clear-theme .score-glow-positive { text-shadow: 0 0 15px rgba(22, 163, 74, 0.4); }
        .crystal-clear-theme .score-glow-negative { text-shadow: 0 0 15px rgba(249, 115, 22, 0.4); }
        .crystal-clear-theme .form-input { background-color: rgba(255, 255, 255, 0.7); border: 1px solid rgba(3, 105, 161, 0.3); color: #075985; }
        .crystal-clear-theme .form-input::placeholder { color: #0ea5e9; }
        .crystal-clear-theme .ring-track { stroke: rgba(3, 105, 161, 0.2); }
        .crystal-clear-theme .ring-wins { stroke: #16a34a; }
        .crystal-clear-theme .ring-losses { stroke: #f97316; }
        .crystal-clear-theme .data-ring-text { color: #075985; }
        .crystal-clear-theme .stats-card { background-color: rgba(255, 255, 255, 0.7); }

        /* --- NEW: Duskfire Theme --- */
        .duskfire-theme { background: linear-gradient(to top, #4c1d95, #f97316, #fef08a); color: #fefce8; font-family: 'Exo 2', sans-serif; }
        .duskfire-theme .main-container { background-color: rgba(40, 20, 60, 0.6); backdrop-filter: blur(16px); border: 2px solid #c2410c; }
        .duskfire-theme .header-text, .duskfire-theme .score-text { color: #fefce8; }
        .duskfire-theme .sub-text { color: #a78bfa; }
        .duskfire-theme .btn-positive { background-color: #c2410c; color: #fefce8; }
        .duskfire-theme .btn-positive:hover { background-color: #ea580c; }
        .duskfire-theme .btn-negative { background-color: #581c87; color: #fefce8; }
        .duskfire-theme .btn-negative:hover { background-color: #6d28d9; }
        .duskfire-theme .btn-neutral { background-color: #9a3412; color: #fefce8; }
        .duskfire-theme .btn-neutral:hover { background-color: #c2410c; }
        .duskfire-theme .btn-secondary, .duskfire-theme .btn-action, .duskfire-theme .dropdown, .duskfire-theme .history-item { background-color: rgba(40, 20, 60, 0.7); border-color: rgba(194, 65, 12, 0.4); color: #fefce8; }
        .duskfire-theme .btn-action { background-color: #9a3412; color: #fefce8; }
        .duskfire-theme .btn-action:hover { background-color: #c2410c; }
        .duskfire-theme .stats-value.positive, .duskfire-theme .profit-positive { color: #c2410c; }
        .duskfire-theme .stats-value.negative, .duskfire-theme .profit-negative { color: #a78bfa; }
        .duskfire-theme .icon-btn { color: #a78bfa; }
        .duskfire-theme .icon-btn:hover { color: #fefce8; }
        .duskfire-theme .score-glow-positive { text-shadow: 0 0 15px rgba(234, 88, 12, 0.6); }
        .duskfire-theme .score-glow-negative { text-shadow: 0 0 15px rgba(167, 139, 250, 0.6); }
        .duskfire-theme .form-input { background-color: rgba(40, 20, 60, 0.7); border: 1px solid #a78bfa; color: #fefce8; }
        .duskfire-theme .form-input::placeholder { color: #a78bfa; }
        .duskfire-theme .ring-track { stroke: rgba(167, 139, 250, 0.3); }
        .duskfire-theme .ring-wins { stroke: #c2410c; }
        .duskfire-theme .ring-losses { stroke: #581c87; }
        .duskfire-theme .data-ring-text { color: #fefce8; }
        .duskfire-theme .stats-card { background-color: rgba(40, 20, 60, 0.7); }

    </style>
</head>
<body class="dark-theme app-body">

    <div class="main-container">
        <!-- Main View -->
        <div id="main-view" class="view active">
            <!-- Header -->
            <header class="flex justify-between items-center h-20 flex-shrink-0">
                <button id="theme-switcher" class="icon-btn">
                    <!-- Theme Icon will be injected here by JS -->
                </button>
                <div class="data-ring-container" id="data-ring">
                    <svg class="data-ring-svg" viewBox="0 0 36 36">
                        <path class="data-ring-circle ring-track" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                        <path id="ring-losses" class="data-ring-circle ring-losses" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                        <path id="ring-wins" class="data-ring-circle ring-wins" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                    </svg>
                    <div class="data-ring-text">
                        <div class="data-ring-total">
                            <span class="value" id="trades-tracker">0</span>
                        </div>
                        <div class="data-ring-details">
                             <div class="flex flex-col items-center">
                                 <span class="profit-value" id="live-profit-detail"></span>
                                 <div class="flex space-x-2 mt-1">
                                     <span class="wl-value" id="wins-tracker-detail">W: 0</span>
                                     <span class="wl-value" id="losses-tracker-detail">L: 0</span>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </header>
    
            <!-- Main Score Display -->
            <div class="text-center my-8 flex flex-col justify-center">
                <h2 class="text-8xl font-bold score-text transition-shadow duration-300" id="main-score">0.0</h2>
            </div>
    
            <!-- Action Buttons and Logs -->
            <div class="mt-auto">
                <!-- Template Selector -->
                <div class="flex items-center justify-center space-x-2 mb-6">
                    <select id="template-selector" class="dropdown rounded-md px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                    <button id="calc-btn" title="Calculator" class="icon-btn btn btn-secondary !p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/><path d="M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z"/></svg>
                    </button>
                     <button id="edit-templates-btn" class="btn btn-secondary text-sm !py-2 !px-3">Edit</button>
                </div>
    
                <!-- Buttons Grid -->
                <div id="buttons-container" class="grid grid-cols-3 gap-4"></div>
                
                <!-- Action Buttons -->
                <div class="grid grid-cols-3 gap-4 pt-6 mt-6 border-t border-gray-700">
                      <button id="undo-btn" class="btn btn-secondary col-span-1 flex justify-center items-center"></button>
                      <button id="history-btn" class="btn btn-secondary col-span-1 flex justify-center items-center"></button>
                      <button id="reset-btn" class="btn btn-secondary col-span-1 flex justify-center items-center"></button>
                </div>
                
                <!-- Save Button -->
                <div class="pt-4">
                      <button id="save-btn" class="btn btn-action w-full">Save Session</button>
                </div>
    
                <!-- Saved Sessions Log (Toggled) -->
                <div id="saved-sessions-container" class="pt-4 space-y-2 hidden">
                    <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                        <h3 class="text-lg font-semibold header-text">Saved Sessions</h3>
                        <div class="flex items-center space-x-3">
                            <button id="export-all-btn" title="Export All Sessions" class="icon-btn"></button>
                            <button id="wipe-btn" title="Wipe All Sessions" class="icon-btn"></button>
                        </div>
                    </div>
                    <div id="sessions-log" class="text-sm space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Edit Templates View -->
        <div id="edit-templates-view" class="view">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-bold">Edit Templates</h3>
                <button type="button" class="icon-btn close-view-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
            <div class="space-y-4 overflow-y-auto -mr-4 pr-4">
                <div><label for="template-edit-selector" class="text-sm">Select Template to Edit:</label><select id="template-edit-selector" class="form-input"></select></div>
                <div><label for="template-name-input" class="text-sm">Template Name:</label><input type="text" id="template-name-input" class="form-input"></div>
                <div class="grid grid-cols-2 gap-4"><div><label for="instrument-selector" class="text-sm">Instrument</label><select id="instrument-selector" class="form-input"><option value="MES">MES</option><option value="ES">ES</option><option value="MNQ">MNQ</option><option value="NQ">NQ</option></select></div><div><label class="text-sm">Point Value</label><span id="point-value-display" class="form-input bg-gray-700/50 flex items-center justify-center font-semibold"></span></div></div>
                <div><label for="commission-input" class="text-sm">Commission ($ per trade)</label><input type="number" id="commission-input" class="form-input" placeholder="e.g., 1.24"></div>
                <div><label for="positive-buttons-input" class="text-sm">Positive Buttons (comma separated):</label><input type="text" id="positive-buttons-input" class="form-input"></div>
                <div><label for="negative-buttons-input" class="text-sm">Negative Buttons (comma separated):</label><input type="text" id="negative-buttons-input" class="form-input"></div>
                <div class="flex justify-between items-center pt-4"><button id="delete-template-btn" class="btn bg-red-600 text-white text-xs px-3 py-2">Delete</button><div class="space-x-2"><button type="button" class="btn btn-secondary close-view-btn">Close</button><button id="save-template-btn" class="btn btn-action">Save</button></div></div>
            </div>
        </div>

        <!-- Other Views -->
        <div id="reset-view" class="view justify-center text-center">
            <div>
                <h3 class="text-xl font-bold">Are you sure?</h3>
                <p class="text-sm sub-text my-4">This will reset the current session.</p>
                <div class="flex justify-center space-x-4 mt-4">
                    <button type="button" class="btn btn-secondary close-view-btn">Cancel</button>
                    <button id="confirm-reset-btn" class="btn btn-negative px-4 py-2">Reset</button>
                </div>
            </div>
        </div>
        
        <div id="calc-view" class="view">
             <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-bold">Edit Calculation</h3>
                <button type="button" class="icon-btn close-view-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
            <p class="text-sm sub-text mb-2">Separate values with a space.</p>
            <textarea id="calc-input" class="form-input h-24 flex-grow"></textarea>
            <div class="flex justify-end space-x-2 mt-4"><button type="button" class="btn btn-secondary close-view-btn">Cancel</button><button id="update-calc-btn" class="btn btn-action">Update</button></div>
        </div>

        <div id="save-view" class="view">
             <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-bold">Save Session</h3>
                <button type="button" class="icon-btn close-view-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div><label for="save-note" class="text-sm font-medium">Note</label><input type="text" id="save-note" class="form-input" placeholder="e.g., London Session"></div>
                <div><label for="save-date" class="text-sm font-medium">Date</label><input type="date" id="save-date" class="form-input"></div>
                <div><label class="text-sm font-medium">Session Time</label><select id="session-time-selector" class="form-input"><option value="8:30 - 12:30">8:30 - 12:30</option><option value="9:00 - 12:30">9:00 - 12:30</option><option value="9:30-12:30">9:30-12:30</option><option value="12:30-14:50">12:30-14:50</option><option value="Custom">Custom</option></select></div>
                <div id="custom-time-inputs" class="hidden grid grid-cols-2 gap-2"><div><label for="start-time" class="text-xs">Start</label><input type="time" id="start-time" class="form-input"></div><div><label for="end-time" class="text-xs">End</label><input type="time" id="end-time" class="form-input"></div></div>
                <div class="flex justify-end space-x-2 mt-4"><button type="button" class="btn btn-secondary close-view-btn">Cancel</button><button id="confirm-save-btn" class="btn btn-action">Save</button></div>
            </div>
        </div>
        
        <!-- Stats View -->
        <div id="stats-view" class="view">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-bold">Session Statistics</h3>
                <button type="button" class="icon-btn close-view-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
            <div id="stats-content" class="space-y-3 overflow-y-auto -mr-4 pr-4"></div>
        </div>

        <!-- MODIFIED Theme Selector View -->
        <div id="theme-view" class="view">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h3 class="text-xl font-bold header-text">Select a Theme</h3>
                <button type="button" class="icon-btn close-view-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
            <div id="theme-grid" class="grid grid-cols-2 sm:grid-cols-2 gap-4 overflow-y-auto -mr-4 pr-4">
                <!-- Theme cards will be injected here by JS -->
            </div>
        </div>

        <!-- Delete Session Confirmation View -->
        <div id="delete-session-view" class="view justify-center text-center">
            <div>
                <h3 class="text-xl font-bold">Delete Session?</h3>
                <p class="text-sm sub-text my-4">Are you sure you want to delete this session? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4 mt-4">
                    <button type="button" class="btn btn-secondary close-view-btn">Cancel</button>
                    <button id="confirm-delete-session-btn" class="btn btn-negative px-4 py-2">Delete</button>
                </div>
            </div>
        </div>

        <!-- Delete Template Confirmation View -->
        <div id="delete-template-view" class="view justify-center text-center">
            <div>
                <h3 class="text-xl font-bold">Delete Template?</h3>
                <p class="text-sm sub-text my-4">Are you sure you want to delete this template? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4 mt-4">
                    <button type="button" class="btn btn-secondary close-view-btn">Cancel</button>
                    <button id="confirm-delete-template-btn" class="btn btn-negative px-4 py-2">Delete</button>
                </div>
            </div>
        </div>

        <!-- Wipe All Confirmation View -->
        <div id="wipe-all-view" class="view justify-center text-center">
            <div>
                <h3 class="text-xl font-bold">Wipe All Sessions?</h3>
                <p class="text-sm sub-text my-4">This is irreversible and will delete all your saved trading sessions.</p>
                <div class="flex justify-center space-x-4 mt-4">
                    <button type="button" class="btn btn-secondary close-view-btn">Cancel</button>
                    <button id="confirm-wipe-btn" class="btn btn-negative px-4 py-2">Wipe All</button>
                </div>
            </div>
        </div>
        
        <!-- Restore Session View -->
        <div id="restore-session-view" class="view justify-center text-center">
            <div>
                <h3 class="text-xl font-bold">Unsaved Session Found</h3>
                <p class="text-sm sub-text my-4">It looks like you have an unsaved session. Would you like to restore it?</p>
                <div class="flex justify-center space-x-4 mt-4">
                    <button id="discard-session-btn" class="btn btn-secondary">Discard</button>
                    <button id="restore-session-btn" class="btn btn-action px-4 py-2">Restore</button>
                </div>
            </div>
        </div>

        <div id="status-bar" class="text-xs text-center p-2 sub-text mt-auto"></div>
    </div>
    
    <!-- Firebase SDKs (Modular Version) -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, onSnapshot, setDoc, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            if (window.myTradingAppInitialized) {
                return;
            }
            window.myTradingAppInitialized = true;

            // --- FIREBASE CONFIG (Using provided variables) ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "AIzaSyAjtH-8qhMjQCgNfwq8xO90gu8cHA9dQeA",
                authDomain: "modern-tracker.firebaseapp.com",
                projectId: "modern-tracker",
                storageBucket: "modern-tracker.appspot.com",
                messagingSenderId: "830990577812",
                appId: "1:830990577812:web:624ccd2c304b6385844481"
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-trading-tracker';

            // --- GLOBAL STATE & DOM ELEMENTS ---
            let score = 0.0, wins = 0, losses = 0, totalTrades = 0, maxWin = 0, maxLoss = 0;
            let history = [], templates = {}, savedSessionsData = [];
            let userId = null, sessionToDeleteId = null, templateToDeleteName = null;
            let db, auth; // Make db and auth accessible in the broader scope

            const mainContainerEl = document.querySelector('.main-container');
            const mainScoreEl = document.getElementById('main-score');
            const winsTrackerDetailEl = document.getElementById('wins-tracker-detail');
            const lossesTrackerDetailEl = document.getElementById('losses-tracker-detail');
            const tradesTrackerEl = document.getElementById('trades-tracker');
            const buttonsContainer = document.getElementById('buttons-container');
            const templateSelector = document.getElementById('template-selector');
            const themeSwitcher = document.getElementById('theme-switcher');
            const dataRingContainer = document.getElementById('data-ring');
            const ringWinsEl = document.getElementById('ring-wins');
            const ringLossesEl = document.getElementById('ring-losses');
            const liveProfitDetailEl = document.getElementById('live-profit-detail');
            const statusBar = document.getElementById('status-bar');

            const paletteIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm4 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM5.5 7a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/><path d="M16 8c0 3.15-1.866 5.959-4.573 7.164a.5.5 0 1 1-.457-.894A7.002 7.002 0 0 0 15 8a.5.5 0 0 1 1 0z"/></svg>`;
            const undoIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/></svg>`;
            const historyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zM11.985 1.795a7.002 7.002 0 0 0-3.582-1.795l.074-.997a8.001 8.001 0 0 1 4.09 2.025l-.71.71A7.001 7.001 0 0 0 11.985 1.795zM4.015 1.795a7.002 7.002 0 0 0-3.582 1.795l.71.71a7.001 7.001 0 0 0 3.582-1.795L4.015 1.795zM1.795 4.015a7.002 7.002 0 0 0-1.795 3.582l.997.074a7.001 7.001 0 0 0 1.795-3.582l-.997-.074zM14.205 4.015a7.002 7.002 0 0 0-1.795-3.582l-.71.71a7.001 7.001 0 0 0 1.795 3.582l.997-.074zM8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 1a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/><path d="M8 5.5a.5.5 0 0 1 .5.5v2.5a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"/></svg>`;
            const resetIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>`;
            const instrumentPointValues = { MES: 5, ES: 50, MNQ: 2, NQ: 20 };
            
            const defaultTemplates = { 
                "ES": { instrument: "ES", pointValue: 50, commission: 4.20, positive: [0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5], negative: [-2, -2.5, -3] },
                "NQ": { instrument: "NQ", pointValue: 20, commission: 4.20, positive: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], negative: [-4, -6, -8, -10] } 
            };

            // --- THEME DATA FOR NEW SELECTOR ---
            const themeData = [
                { id: 'dark-theme', name: 'Dark', font: "'Poppins', sans-serif", colors: { bg: 'rgba(17, 17, 17, 0.8)', text: '#F9FAFB', border: '#48bb78', p: '#15803d', n: '#b91c1c', a: '#374151' } },
                { id: 'ice-theme', name: 'Ice', font: "'Lato', sans-serif", colors: { bg: 'rgba(255, 255, 255, 0.8)', text: '#2d3748', border: '#805ad5', p: '#3182ce', n: '#805ad5', a: '#e2e8f0' } },
                { id: 'sunrise-theme', name: 'Sunrise', font: "'Lato', sans-serif", colors: { bg: 'rgba(255, 255, 255, 0.65)', text: '#422006', border: '#F97316', p: '#F97316', n: '#581C87', a: '#854D0E' } },
                { id: 'cyberpunk-theme', name: 'Cyberpunk', font: "'Orbitron', sans-serif", colors: { bg: 'rgba(10, 10, 25, 0.7)', text: '#A5F3FC', border: '#F472B6', p: '#22D3EE', n: '#F472B6', a: '#A3E635' } },
                { id: 'forest-theme', name: 'Forest', font: "'Nunito', sans-serif", colors: { bg: 'rgba(20, 40, 35, 0.8)', text: '#EAE7E2', border: '#6EE7B7', p: '#6EE7B7', n: '#E57373', a: '#8D6E63' } },
                { id: 'crimson-theme', name: 'Crimson', font: "'Merriweather', serif", colors: { bg: 'rgba(28, 28, 28, 0.8)', text: '#F5F5F5', border: '#DC2626', p: '#B91C1C', n: '#4B5563', a: '#D4AF37' } },
                { id: 'blueprint-theme', name: 'Blueprint', font: "'Roboto Mono', monospace", colors: { bg: 'rgba(5, 20, 45, 0.8)', text: '#FFFFFF', border: '#7DD3FC', p: '#4ADE80', n: '#FACC15', a: '#FFFFFF' } },
                { id: 'monochrome-theme', name: 'Monochrome', font: "'Inter', sans-serif", colors: { bg: '#FFFFFF', text: '#111827', border: '#111827', p: '#111827', n: '#E5E7EB', a: '#D1D5DB' } },
                { id: 'oceanic-theme', name: 'Oceanic', font: "'Source Sans Pro', sans-serif", colors: { bg: 'rgba(10, 30, 60, 0.8)', text: '#E0E7FF', border: '#64ffda', p: '#FF7F50', n: '#4f8fc0', a: '#64ffda' } },
                { id: 'iridescent-theme', name: 'Iridescent', font: "'Poppins', sans-serif", colors: { bg: 'rgba(255, 255, 255, 0.4)', text: '#0f766e', border: '#d8b4fe', p: 'rgba(167, 243, 208, 0.7)', n: 'rgba(251, 207, 232, 0.7)', a: 'rgba(216, 180, 254, 0.7)' } },
                { id: 'nebula-theme', name: 'Nebula', font: "'Exo 2', sans-serif", colors: { bg: 'rgba(10, 10, 20, 0.7)', text: '#F0F9FF', border: '#A855F7', p: '#14B8A6', n: '#D946EF', a: '#6366F1' } },
                { id: 'supernova-theme', name: 'Supernova', font: "'Space Mono', monospace", colors: { bg: 'rgba(20, 20, 20, 0.7)', text: '#FFFBEB', border: '#FACC15', p: '#F97316', n: '#4F46E5', a: '#FACC15' } },
                { id: 'nocturne-theme', name: 'Nocturne', font: "'DM Sans', sans-serif", colors: { bg: 'rgba(10, 10, 10, 0.8)', text: '#E5E5E5', border: '#8B0000', p: '#006400', n: '#8B0000', a: '#4169E1' } },
                { id: 'obsidian-theme', name: 'Obsidian', font: "'IBM Plex Mono', monospace", colors: { bg: 'rgba(28, 28, 30, 0.8)', text: '#FFFFFF', border: '#A1A1AA', p: '#38BDF8', n: '#3F3F46', a: '#FFFFFF' } },
                { id: 'emerald-theme', name: 'Emerald', font: "'JetBrains Mono', monospace", colors: { bg: 'rgba(15, 23, 42, 0.7)', text: '#E2E8F0', border: '#10B981', p: '#10B981', n: '#3730A3', a: '#334155' } },
                { id: 'volcano-theme', name: 'Volcano', font: "'Russo One', sans-serif", colors: { bg: 'rgba(15, 15, 15, 0.8)', text: '#FFF7ED', border: '#FF4500', p: '#DC2626', n: '#36454F', a: '#FF8C00' } },
                { id: 'phantom-theme', name: 'Phantom', font: "'Inter', sans-serif", colors: { bg: 'rgba(28, 28, 30, 0.8)', text: '#FFFFFF', border: '#A1A1AA', p: '#9CA3AF', n: '#4B5563', a: '#6B7280' } },
                { id: 'carbon-theme', name: 'Carbon', font: "'Oxanium', sans-serif", colors: { bg: 'rgba(0, 0, 0, 0.7)', text: '#FFFFFF', border: '#EF4444', p: '#EF4444', n: '#444', a: '#BBB' } },
                { id: 'aura-theme', name: 'Aura', font: "'Montserrat', sans-serif", colors: { bg: 'rgba(255, 255, 255, 0.6)', text: '#444444', border: '#A78BFA', p: '#FFDAB9', n: '#ADD8E6', a: '#A78BFA' } },
                { id: 'frostfire-theme', name: 'Frostfire', font: "'Orbitron', sans-serif", colors: { bg: 'rgba(255, 255, 255, 0.2)', text: '#FFFFFF', border: '#F97316', p: '#F97316', n: '#3B82F6', a: '#60A5FA' } },
                { id: 'gilded-theme', name: 'Gilded', font: "'Cinzel', serif", colors: { bg: 'rgba(25, 25, 25, 0.8)', text: '#EAEAEA', border: '#E6B800', p: '#E6B800', n: '#333333', a: '#FFD700' } },
                { id: 'black-gold-theme', name: 'Black Gold', font: "'Cormorant Garamond', serif", colors: { bg: 'rgba(20, 20, 20, 0.8)', text: '#F5F5F4', border: '#D4AF37', p: '#D4AF37', n: '#A8A29E', a: '#1C1917' } },
                { id: 'midnight-bloom-theme', name: 'Midnight Bloom', font: "'DM Sans', sans-serif", colors: { bg: 'rgba(29, 26, 63, 0.5)', text: '#e0e7ff', border: '#f43f5e', p: '#22d3ee', n: '#f43f5e', a: '#a78bfa' } },
                { id: 'crystal-clear-theme', name: 'Crystal Clear', font: "'Inter', sans-serif", colors: { bg: 'rgba(255, 255, 255, 0.55)', text: '#075985', border: '#6366f1', p: '#16a34a', n: '#f97316', a: '#6366f1' } },
                { id: 'duskfire-theme', name: 'Duskfire', font: "'Exo 2', sans-serif", colors: { bg: 'rgba(40, 20, 60, 0.6)', text: '#fefce8', border: '#c2410c', p: '#c2410c', n: '#581c87', a: '#9a3412' } },
            ];
            
            // --- NEW: Animation Theme Mapping ---
            const rippleThemes = new Set(['cyberpunk-theme', 'blueprint-theme', 'oceanic-theme', 'emerald-theme', 'crimson-theme', 'volcano-theme', 'gilded-theme', 'black-gold-theme', 'frostfire-theme']);
            const borderPulseThemes = new Set(['ice-theme', 'sunrise-theme', 'forest-theme', 'iridescent-theme', 'nebula-theme', 'supernova-theme', 'nocturne-theme', 'obsidian-theme', 'carbon-theme', 'aura-theme', 'duskfire-theme']);
            const flashThemes = new Set(['midnight-bloom-theme', 'crystal-clear-theme']);


            // --- UI & CORE LOGIC FUNCTIONS ---
            const applyTheme = (theme) => {
                document.body.className = `app-body ${theme}`;
                localStorage.setItem('plTrackerTheme', theme);
                updateThemeSelectionVisuals();
            };
            
            const showView = (viewId) => {
                document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                const viewToShow = document.getElementById(viewId);
                if (viewToShow) {
                    viewToShow.classList.add('active');
                }
                if (viewId === 'theme-view') {
                    updateThemeSelectionVisuals();
                }
            };
            
            const setStatus = (message, type = 'loading') => {
                if (!statusBar) return;
                const icons = {
                    loading: `<svg class="animate-spin h-4 w-4 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`,
                    success: `<svg class="h-4 w-4 inline-block mr-2 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
                    error: `<svg class="h-4 w-4 inline-block mr-2 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`
                };
                statusBar.innerHTML = `${icons[type]} ${message}`;
                statusBar.className = `text-xs text-center p-2 mt-auto ${type === 'error' ? 'text-red-400' : 'sub-text'}`;

                if (type !== 'loading') {
                    setTimeout(() => { statusBar.innerHTML = ''; }, 3000);
                }
            };
            
            const copyToClipboard = (text) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    setStatus('Copied to clipboard!', 'success');
                } catch (err) {
                    setStatus('Failed to copy.', 'error');
                }
                document.body.removeChild(textarea);
            };

            const animateValue = (element, start, end, duration) => {
                if (start === end) return;
                let startTime = null;
                const step = (currentTime) => {
                    if (!startTime) startTime = currentTime;
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    const currentValue = start + (end - start) * progress;
                    element.textContent = currentValue.toFixed(1);
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        element.textContent = end.toFixed(1);
                    }
                };
                window.requestAnimationFrame(step);
            };
            const updateDataRing = () => {
                const winP = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
                const lossP = totalTrades > 0 ? (losses / totalTrades) * 100 : 0;
                ringWinsEl.style.strokeDasharray = `${winP} ${100 - winP}`;
                ringLossesEl.style.strokeDasharray = `${lossP} ${100 - lossP}`;
                ringLossesEl.style.strokeDashoffset = -winP;
            };
            const updateDisplay = (previousScore = score) => {
                animateValue(mainScoreEl, previousScore, score, 200);
                mainScoreEl.classList.toggle('score-glow-positive', score > 0);
                mainScoreEl.classList.toggle('score-glow-negative', score < 0);
                winsTrackerDetailEl.textContent = `W: ${wins}`;
                lossesTrackerDetailEl.textContent = `L: ${losses}`;
                tradesTrackerEl.textContent = totalTrades;
                
                const currentTemplate = templates[templateSelector.value];
                if (totalTrades > 0 && currentTemplate?.pointValue != null && currentTemplate?.commission != null) {
                    const profit = (score * currentTemplate.pointValue) - (totalTrades * currentTemplate.commission);
                    liveProfitDetailEl.textContent = `$${profit.toFixed(2)}`;
                    liveProfitDetailEl.classList.remove('profit-positive', 'profit-negative');
                    liveProfitDetailEl.classList.add(profit >= 0 ? 'profit-positive' : 'profit-negative');
                } else {
                    liveProfitDetailEl.textContent = '';
                }

                updateDataRing();
            };

            // --- THEME SELECTOR LOGIC ---
            const renderThemeSelector = () => {
                const grid = document.getElementById('theme-grid');
                if (!grid) return;
                grid.innerHTML = ''; // Clear existing
                
                themeData.forEach(theme => {
                    const card = document.createElement('div');
                    card.className = 'theme-card';
                    card.dataset.theme = theme.id;
                    card.style.background = theme.colors.bg;
                    card.style.color = theme.colors.text;
                    card.style.borderColor = theme.colors.border + '80'; // Add transparency

                    card.innerHTML = `
                        <div class="checkmark-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg>
                        </div>
                        <div class="theme-card-header">
                            <span class="theme-name-new" style="font-family: ${theme.font};">${theme.name}</span>
                        </div>
                        <div class="theme-swatches">
                            <div class="swatch" style="background: ${theme.colors.p};"></div>
                            <div class="swatch" style="background: ${theme.colors.n};"></div>
                            <div class="swatch" style="background: ${theme.colors.a};"></div>
                            <div class="swatch" style="background: ${theme.colors.text};"></div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            };

            const updateThemeSelectionVisuals = () => {
                const currentTheme = localStorage.getItem('plTrackerTheme') || 'dark-theme';
                const themeCards = document.querySelectorAll('.theme-card');
                themeCards.forEach(card => {
                    const isSelected = card.dataset.theme === currentTheme;
                    card.classList.toggle('selected', isSelected);
                    if (isSelected) {
                        const theme = themeData.find(t => t.id === currentTheme);
                        if(theme) {
                            card.style.setProperty('--selected-theme-border-color', theme.colors.border);
                            card.style.setProperty('--selected-theme-shadow-color', theme.colors.border + '60');
                            const checkmark = card.querySelector('.checkmark-icon');
                            if(checkmark) {
                                checkmark.style.setProperty('--selected-theme-border-color', theme.colors.border);
                            }
                        }
                    }
                });
            };

            const autoSaveSession = async () => {
                if (!userId) return;
                const autoSaveRef = doc(db, 'artifacts', appId, 'users', userId, 'autosave', 'current');
                const sessionData = {
                    score,
                    wins,
                    losses,
                    totalTrades,
                    maxWin,
                    maxLoss,
                    history,
                    template: templateSelector.value,
                    timestamp: new Date()
                };
                await setDoc(autoSaveRef, sessionData);
            };

            const clearAutoSave = async () => {
                if (!userId) return;
                const autoSaveRef = doc(db, 'artifacts', appId, 'users', userId, 'autosave', 'current');
                await deleteDoc(autoSaveRef);
            };
            
            // --- ANIMATION TRIGGER FUNCTIONS ---
            const triggerFlashAnimation = (color) => {
                mainContainerEl.classList.remove('flash-anim', 'border-pulse-anim');
                mainContainerEl.style.setProperty('--anim-color', color);
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                         mainContainerEl.classList.add('flash-anim');
                    });
                });
            };

            const triggerBorderPulseAnimation = (color) => {
                mainContainerEl.classList.remove('flash-anim', 'border-pulse-anim');
                mainContainerEl.style.setProperty('--anim-color', color);
                mainContainerEl.style.setProperty('--anim-color-transparent', color + '00');
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                         mainContainerEl.classList.add('border-pulse-anim');
                    });
                });
                 mainContainerEl.addEventListener('animationend', () => {
                    mainContainerEl.classList.remove('border-pulse-anim');
                }, { once: true });
            };

            const triggerRippleAnimation = (event, color) => {
                const button = event.currentTarget;
                if (!button) return;
                const ripple = document.createElement("span");
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                
                ripple.style.width = ripple.style.height = `${size}px`;
                ripple.style.left = `${event.clientX - rect.left - size / 2}px`;
                ripple.style.top = `${event.clientY - rect.top - size / 2}px`;
                ripple.style.setProperty('--anim-color', color);
                ripple.classList.add("ripple");

                button.appendChild(ripple);

                ripple.addEventListener('animationend', () => {
                    ripple.remove();
                }, { once: true });
            };
            
            const triggerScorePulseAnimation = (color) => {
                if (!mainScoreEl) return;
                mainScoreEl.classList.remove('score-pulse-anim');
                mainScoreEl.style.setProperty('--anim-color', color);
                requestAnimationFrame(() => {
                    mainScoreEl.classList.add('score-pulse-anim');
                });
                mainScoreEl.addEventListener('animationend', () => {
                    mainScoreEl.classList.remove('score-pulse-anim');
                }, { once: true });
            };


            const handleButtonClick = async (event, value) => { 
                const previousScore = score; 
                history.push({ state: { score, wins, losses, totalTrades, maxWin, maxLoss }, value }); 
                score += value; 
                totalTrades++; 
                if (value > 0) wins++; 
                else if (value < 0) losses++; 

                const currentTemplate = templates[templateSelector.value];
                if (currentTemplate) {
                    const profit = (score * currentTemplate.pointValue) - (totalTrades * currentTemplate.commission);
                    maxWin = Math.max(maxWin, profit);
                    maxLoss = Math.min(maxLoss, profit);
                }

                // --- ANIMATION DISPATCHER ---
                const currentThemeId = localStorage.getItem('plTrackerTheme');
                const themeInfo = themeData.find(t => t.id === currentThemeId);
                if (themeInfo) {
                    let animColor;
                    if (value > 0) animColor = themeInfo.colors.p;
                    else if (value < 0) animColor = themeInfo.colors.n;
                    else animColor = themeInfo.colors.a;
                    
                    // Trigger score pulse on every theme
                    triggerScorePulseAnimation(animColor);

                    if (flashThemes.has(currentThemeId)) {
                        triggerFlashAnimation(animColor);
                    } else if (borderPulseThemes.has(currentThemeId)) {
                        triggerBorderPulseAnimation(animColor);
                    } else if (rippleThemes.has(currentThemeId)) {
                        triggerRippleAnimation(event, animColor);
                    }
                }

                updateDisplay(previousScore);
                await autoSaveSession();
            };

            const resetCalculator = async () => { 
                const previousScore = score; 
                score = 0.0; 
                wins = 0; 
                losses = 0; 
                totalTrades = 0; 
                history = []; 
                maxWin = 0; 
                maxLoss = 0; 
                updateDisplay(previousScore); 
                await clearAutoSave();
            };
            const renderButtons = (templateName) => {
                const template = templates[templateName];
                if (!template) return;
                buttonsContainer.innerHTML = '';
                const allButtons = [...(template.positive || []).sort((a, b) => a - b), 0, ...(template.negative || []).sort((a, b) => b - a)];
                allButtons.forEach(val => {
                    const button = document.createElement('button');
                    button.textContent = (val > 0 ? '+' : '') + (parseFloat(val) === parseInt(val) ? val : val.toFixed(1));
                    button.className = `calc-btn ${val > 0 ? 'btn-positive' : val < 0 ? 'btn-negative' : 'btn-neutral'}`;
                    button.onclick = (e) => handleButtonClick(e, val); // Pass event and value
                    buttonsContainer.appendChild(button);
                });
            };
            const populateTemplateSelectors = () => {
                const currentMainVal = templateSelector.value;
                const editSelector = document.getElementById('template-edit-selector');
                templateSelector.innerHTML = '';
                editSelector.innerHTML = '<option value="" disabled selected>Select or Add New</option><option value="_new">-- Add New Template --</option>';
                const sortedNames = Object.keys(templates).sort();
                sortedNames.forEach(name => { const option = new Option(name, name); templateSelector.add(option.cloneNode(true)); editSelector.add(option); });
                templateSelector.value = templates[currentMainVal] ? currentMainVal : (sortedNames[0] || '');
                editSelector.value = "";
            };
            const formatDate = (isoDate) => { if (!isoDate || typeof isoDate !== 'string' || isoDate.length < 10) return ''; const [y, m, d] = isoDate.split('-'); return `${d}/${m}/${y}`; };
            
            // --- FIRESTORE FUNCTIONS (MODULAR) ---
            const saveTemplateToFirestore = async (name, templateData) => { if (userId && name) await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'templates', name), templateData); };
            const deleteTemplateFromFirestore = async (name) => { if (userId && name && Object.keys(templates).length > 1) { await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'templates', name)); } else { setStatus("Cannot delete the last template.", "error"); } };
            const saveSessionToFirestore = async (sessionData) => { if(userId) await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'sessions'), sessionData); };
            const deleteSession = async (sessionId) => { if (userId && sessionId) await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'sessions', sessionId)); };
            const wipeAllSessions = async () => {
                if (!userId) return;
                const q = query(collection(db, 'artifacts', appId, 'users', userId, 'sessions'));
                const snapshot = await getDocs(q);
                await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref)));
            };

            // --- AUTHENTICATION & DATA LOADING ---
            async function initializeAndLoadData() {
                if (!userId) return;
                setStatus('Loading data...', 'loading');
                
                const templatesRef = collection(db, 'artifacts', appId, 'users', userId, 'templates');
                const sessionsRef = collection(db, 'artifacts', appId, 'users', userId, 'sessions');
                const autoSaveRef = doc(db, 'artifacts', appId, 'users', userId, 'autosave', 'current');

                try {
                    const [templateSnapshot, autoSaveSnap] = await Promise.all([getDocs(templatesRef), getDoc(autoSaveRef)]);

                    if (templateSnapshot.empty) {
                        await Promise.all(Object.entries(defaultTemplates).map(([name, data]) => 
                            setDoc(doc(templatesRef, name), data)
                        ));
                    }

                    onSnapshot(templatesRef, (snapshot) => {
                        templates = {};
                        snapshot.forEach(doc => { templates[doc.id] = doc.data(); });
                        populateTemplateSelectors();
                        
                        if (autoSaveSnap.exists()) {
                            const data = autoSaveSnap.data();
                            document.getElementById('restore-session-btn').onclick = async () => {
                                score = data.score;
                                wins = data.wins;
                                losses = data.losses;
                                totalTrades = data.totalTrades;
                                maxWin = data.maxWin;
                                maxLoss = data.maxLoss;
                                history = data.history;
                                templateSelector.value = data.template;
                                
                                renderButtons(templateSelector.value);
                                updateDisplay(0);
                                await clearAutoSave();
                                showView('main-view');
                            };
                             document.getElementById('discard-session-btn').onclick = async () => {
                                await clearAutoSave();
                                renderButtons(templateSelector.value || Object.keys(templates)[0]);
                                showView('main-view');
                            };
                            showView('restore-session-view');
                        } else {
                            renderButtons(templateSelector.value || Object.keys(templates)[0]);
                        }
                        setStatus('Ready', 'success');
                    }, (error) => {
                        console.error("Template listener error:", error);
                        setStatus('Error loading templates.', 'error');
                    });

                    onSnapshot(query(sessionsRef), (snapshot) => {
                        const log = document.getElementById('sessions-log');
                        log.innerHTML = '';
                        savedSessionsData = [];
                        snapshot.forEach(doc => savedSessionsData.push({ id: doc.id, ...doc.data() }));
                        
                        savedSessionsData.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(data => {
                            const el = document.createElement('div');
                            el.className = 'history-item p-2 rounded-md flex justify-between items-center';
                            el.innerHTML = `<div class="flex-grow"><div><span class="font-bold">${formatDate(data.date)}</span><span class="text-xs ml-2">${data.sessionTime}</span></div><div class="text-xs mt-1">${data.note}</div><div class="text-right mt-1"><span class="font-bold ${data.score >= 0 ? 'profit-positive' : 'profit-negative'}">${parseFloat(data.score).toFixed(1)}</span><span class="text-xs ml-2">W:${data.wins} L:${data.losses} T:${data.totalTrades}</span></div></div><div class="flex flex-col items-center space-y-2 ml-2"><button title="Show Stats" class="icon-btn stats-btn" data-session-id="${data.id}"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2zm1 12h2V2h-2v12zm-3 0V7H7v7h2zm-4 0v-3H2v3h2z"/></svg></button><button title="Export to Clipboard" class="icon-btn export-btn" data-session-id="${data.id}"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 8a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1H-.5a.5.5 0 0 1-.5-.5z"/></svg></button><button title="Delete Session" class="icon-btn delete-btn" data-session-id="${data.id}"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div>`;
                            log.appendChild(el);
                        });
                    }, (error) => {
                        console.error("Session listener error:", error);
                        setStatus('Error loading sessions.', 'error');
                    });
                } catch (error) {
                    console.error("Error setting up listeners:", error);
                    setStatus('Error connecting to database.', 'error');
                }
            }
            
            // --- EVENT LISTENERS ---
            const setupEventListeners = () => {
                themeSwitcher.addEventListener('click', () => showView('theme-view'));
                dataRingContainer.addEventListener('click', () => dataRingContainer.classList.toggle('show-details'));
                templateSelector.addEventListener('change', (e) => renderButtons(e.target.value));
                document.getElementById('undo-btn').addEventListener('click', async () => { 
                    if (history.length > 0) { 
                        const lastEntry = history.pop(); 
                        const lastState = lastEntry.state; 
                        const currentScore = score; 
                        score = lastState.score; 
                        wins = lastState.wins; 
                        losses = lastState.losses; 
                        totalTrades = lastState.totalTrades; 
                        maxWin = lastState.maxWin; 
                        maxLoss = lastState.maxLoss; 
                        updateDisplay(currentScore); 
                        await autoSaveSession();
                    } 
                });
                document.getElementById('history-btn').addEventListener('click', () => document.getElementById('saved-sessions-container').classList.toggle('hidden'));
                
                // View Openers
                document.getElementById('edit-templates-btn').addEventListener('click', () => showView('edit-templates-view'));
                document.getElementById('reset-btn').addEventListener('click', () => showView('reset-view'));
                document.getElementById('calc-btn').addEventListener('click', () => {
                    document.getElementById('calc-input').value = history.map(h => h.value).join(' ');
                    showView('calc-view');
                });
                document.getElementById('save-btn').addEventListener('click', () => {
                    const saveDateInput = document.getElementById('save-date');
                    if (saveDateInput) {
                        saveDateInput.valueAsDate = new Date();
                    }
                    showView('save-view');
                });
                
                // View Closers
                document.querySelectorAll('.close-view-btn').forEach(btn => {
                    btn.addEventListener('click', () => showView('main-view'));
                });
                
                // View Actions
                document.getElementById('confirm-reset-btn').addEventListener('click', async () => { 
                    await resetCalculator(); 
                    showView('main-view'); 
                });
                document.getElementById('update-calc-btn').addEventListener('click', async (e) => { 
                    const values = document.getElementById('calc-input').value.trim().split(' ').map(Number).filter(n => !isNaN(n)); 
                    await resetCalculator(); 
                    for (const val of values) {
                        await handleButtonClick(e, val);
                    }
                    showView('main-view'); 
                });
                document.getElementById('save-template-btn').addEventListener('click', async () => { const name = document.getElementById('template-name-input').value.trim(); const instrument = document.getElementById('instrument-selector').value; const pointValue = instrumentPointValues[instrument]; const commission = parseFloat(document.getElementById('commission-input').value); if (!name || !instrument || isNaN(commission)) { setStatus('Template Name, Instrument, and Commission are required.', 'error'); return; } const positive = document.getElementById('positive-buttons-input').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n) && n >= 0); const negative = document.getElementById('negative-buttons-input').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n) && n <= 0); if(!positive.length && !negative.length) { setStatus('At least one positive or negative button value is required.', 'error'); return; } await saveTemplateToFirestore(name, { instrument, pointValue, commission, positive, negative }); showView('main-view'); });
                
                document.getElementById('session-time-selector').addEventListener('change', (e) => {
                    document.getElementById('custom-time-inputs').classList.toggle('hidden', e.target.value !== 'Custom');
                });

                document.getElementById('confirm-save-btn').addEventListener('click', async () => { 
                    const currentTemplate = templates[templateSelector.value];
                    if (!currentTemplate) { setStatus("Please select a valid template.", "error"); return; }
                    let sessionTime = document.getElementById('session-time-selector').value; 
                    if (sessionTime === 'Custom') { const start = document.getElementById('start-time').value; const end = document.getElementById('end-time').value; sessionTime = (start && end) ? `${start} - ${end}` : 'Custom'; } 
                    const saveDateInput = document.getElementById('save-date');
                    if (!saveDateInput.value) { setStatus("Please select a date to save the session.", "error"); return; }
                    await saveSessionToFirestore({ note: document.getElementById('save-note').value || 'No note', date: saveDateInput.value, sessionTime, score, wins, losses, totalTrades, instrument: currentTemplate.instrument, pointValue: currentTemplate.pointValue, commission: currentTemplate.commission, maxWin, maxLoss }); 
                    await clearAutoSave();
                    showView('main-view');
                });

                // --- EVENT LISTENERS FOR TEMPLATES & SESSIONS ---

                // MODIFIED Theme selection
                document.getElementById('theme-view').addEventListener('click', (e) => {
                    const card = e.target.closest('.theme-card');
                    if (card) {
                        const theme = card.dataset.theme;
                        applyTheme(theme);
                        showView('main-view');
                    }
                });

                // Edit Template Listeners
                const templateEditSelector = document.getElementById('template-edit-selector');
                const templateNameInput = document.getElementById('template-name-input');
                const instrumentSelectorEdit = document.getElementById('instrument-selector');
                const pointValueDisplay = document.getElementById('point-value-display');
                const commissionInput = document.getElementById('commission-input');
                const positiveButtonsInput = document.getElementById('positive-buttons-input');
                const negativeButtonsInput = document.getElementById('negative-buttons-input');
                const deleteTemplateBtn = document.getElementById('delete-template-btn');

                instrumentSelectorEdit.addEventListener('change', () => {
                    pointValueDisplay.textContent = instrumentPointValues[instrumentSelectorEdit.value] || '';
                });

                templateEditSelector.addEventListener('change', () => {
                    const templateName = templateEditSelector.value;
                    if (templateName === '_new') {
                        templateNameInput.value = '';
                        instrumentSelectorEdit.value = 'ES';
                        commissionInput.value = '';
                        positiveButtonsInput.value = '';
                        negativeButtonsInput.value = '';
                        deleteTemplateBtn.classList.add('hidden');
                    } else {
                        const template = templates[templateName];
                        if (template) {
                            templateNameInput.value = templateName;
                            instrumentSelectorEdit.value = template.instrument;
                            commissionInput.value = template.commission;
                            positiveButtonsInput.value = (template.positive || []).join(', ');
                            negativeButtonsInput.value = (template.negative || []).join(', ');
                            deleteTemplateBtn.classList.remove('hidden');
                        }
                    }
                    instrumentSelectorEdit.dispatchEvent(new Event('change'));
                });
                
                deleteTemplateBtn.addEventListener('click', () => {
                    templateToDeleteName = templateNameInput.value;
                    if (templateToDeleteName) {
                        showView('delete-template-view');
                    }
                });

                document.getElementById('confirm-delete-template-btn').addEventListener('click', async () => {
                    if (templateToDeleteName) {
                        await deleteTemplateFromFirestore(templateToDeleteName);
                        templateToDeleteName = null;
                        showView('main-view');
                        setStatus('Template deleted.', 'success');
                    }
                });

                // Event delegation for session item buttons
                document.getElementById('sessions-log').addEventListener('click', (e) => {
                    const button = e.target.closest('.icon-btn');
                    if (!button) return;

                    const sessionId = button.dataset.sessionId;
                    const session = savedSessionsData.find(s => s.id === sessionId);

                    if (button.classList.contains('delete-btn')) {
                        sessionToDeleteId = sessionId;
                        showView('delete-session-view');
                    } else if (button.classList.contains('export-btn')) {
                        if (session) {
                             const row = [
                                formatDate(session.date),
                                session.score.toFixed(1),
                                session.wins,
                                session.losses,
                                session.totalTrades,
                                `$${(session.maxLoss || 0).toFixed(2)}`,
                                session.sessionTime,
                                session.note
                            ].join('\t');
                            copyToClipboard(row);
                        }
                    } else if (button.classList.contains('stats-btn')) {
                        if (session) {
                            const profit = (session.score * session.pointValue) - (session.totalTrades * session.commission);
                            const winRate = session.totalTrades > 0 ? ((session.wins / session.totalTrades) * 100).toFixed(1) : '0.0';
                            const statsContent = document.getElementById('stats-content');
                            statsContent.innerHTML = `
                                <div class="stats-card p-4 rounded-lg">
                                    <div class="grid grid-cols-2 gap-4 text-center">
                                        <div><div class="stats-label">Date</div><div class="stats-value">${formatDate(session.date)}</div></div>
                                        <div><div class="stats-label">Instrument</div><div class="stats-value">${session.instrument}</div></div>
                                        <div><div class="stats-label">P/L</div><div class="stats-value ${profit >= 0 ? 'positive' : 'negative'}">$${profit.toFixed(2)}</div></div>
                                        <div><div class="stats-label">Score</div><div class="stats-value">${session.score.toFixed(1)}</div></div>
                                        <div><div class="stats-label">Win Rate</div><div class="stats-value">${winRate}%</div></div>
                                        <div><div class="stats-label">Wins</div><div class="stats-value positive">${session.wins}</div></div>
                                        <div><div class="stats-label">Losses</div><div class="stats-value negative">${session.losses}</div></div>
                                        <div><div class="stats-label">High P/L</div><div class="stats-value positive">$${(session.maxWin || 0).toFixed(2)}</div></div>
                                        <div class="col-span-2"><div class="stats-label">Low P/L</div><div class="stats-value negative">$${(session.maxLoss || 0).toFixed(2)}</div></div>
                                    </div>
                                </div>
                            `;
                            showView('stats-view');
                        }
                    }
                });

                document.getElementById('confirm-delete-session-btn').addEventListener('click', async () => {
                    if (sessionToDeleteId) {
                        await deleteSession(sessionToDeleteId);
                        sessionToDeleteId = null;
                        showView('main-view');
                        setStatus('Session deleted.', 'success');
                    }
                });

                // Export All Sessions
                document.getElementById('export-all-btn').addEventListener('click', () => {
                    if (savedSessionsData.length === 0) {
                        setStatus('No sessions to export.', 'error');
                        return;
                    }
                    const allSessionsRows = savedSessionsData.map(session => {
                        return [
                            formatDate(session.date),
                            session.score.toFixed(1),
                            session.wins,
                            session.losses,
                            session.totalTrades,
                            `$${(session.maxLoss || 0).toFixed(2)}`,
                            session.sessionTime,
                            session.note
                        ].join('\t');
                    });
                    const allSessionsText = allSessionsRows.join('\n');
                    copyToClipboard(allSessionsText);
                });

                // Wipe All Sessions
                document.getElementById('wipe-btn').addEventListener('click', () => {
                    showView('wipe-all-view');
                });
                
                document.getElementById('confirm-wipe-btn').addEventListener('click', async () => {
                    await wipeAllSessions();
                    showView('main-view');
                    setStatus('All sessions wiped.', 'success');
                });
                
                // Set initial icons
                document.getElementById('theme-switcher').innerHTML = paletteIcon;
                document.getElementById('undo-btn').innerHTML = undoIcon;
                document.getElementById('history-btn').innerHTML = historyIcon;
                document.getElementById('reset-btn').innerHTML = resetIcon;
                document.getElementById('export-all-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>`;
                document.getElementById('wipe-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-red-500 hover:text-red-400" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>`;
            };
            
            // --- INITIALIZATION ---
            setStatus('Connecting...');
            try {
                // If there's no apiKey in the config object, it means the user hasn't added their config.
                if (Object.keys(firebaseConfig).length === 0 && typeof __firebase_config === 'undefined') {
                    throw new Error("Firebase config is missing. Please add your Firebase configuration object to the script.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setStatus('Authenticating...', 'loading');
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        if (!userId) { // Prevents re-initialization on token refresh
                            userId = user.uid;
                            await initializeAndLoadData();
                        }
                    } else {
                        await signInAnonymously(auth).catch(err => {
                            console.error("Anonymous sign-in failed:", err);
                            setStatus('Authentication Failed.', 'error');
                        });
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                setStatus(error.message, 'error');
            }

            // Initial setup calls
            renderThemeSelector();
            applyTheme(localStorage.getItem('plTrackerTheme') || 'dark-theme');
            setupEventListeners();
        });
    </script>

</body>
</html>
